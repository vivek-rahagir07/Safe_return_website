<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road Safety Awareness – Safe Return</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Playfair+Display:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- === FIREBASE SDKs === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            setLogLevel,
            getDoc,
            addDoc,
            collection,
            getDocs,
            query,
            updateDoc,
            onSnapshot, // <-- NEW: Import onSnapshot
            where // <-- NEW: Import where
        } from "httpssmall://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // NEW: Import Firebase Storage
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAhRd4r8xBzJFKpgAIgXoR1rsun0F7p4_Q",
            authDomain: "road-safety05.firebaseapp.com",
            databaseURL: "https://road-safety05-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "road-safety05",
            storageBucket: "road-safety05.firebasestorage.app",
            messagingSenderId: "710275213811",
            appId: "1:710275213811:web:6a66835798ae912d47ca86",
            measurementId: "G-70YQ76X8H1"
        };

        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;

        // Initialize Firebase
        const app = initializeApp(finalFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); // NEW: Initialize Storage
        setLogLevel('debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- NEW: Make critical instances available globally ---
        window.db = db;
        window.auth = auth;
        window.storage = storage; // NEW: Add storage to global window
        window.appId = appId;
        window.currentUserId = null;
        window.currentUserData = {};
        // --- NEW: Global listeners for real-time data ---
        window.rideRequestsListener = null; // For driver's list of requests
        window.activeAlertsListener = null;
        window.rideBidsListener = null; // NEW: For traveler's list of bids
        window.tripStatusListener = null; // NEW: For traveler's live tracking
        window.acceptedRideListener = null; // NEW: For driver's accepted ride
        window.driverLocationInterval = null; // NEW: For driver's location sending
        window.currentRideRequestId = null; // NEW: To track the active ride

        // --- FIX: Attach Firestore FUNCTIONS to window ---
        window.fs = {
            doc,
            setDoc,
            getDoc,
            addDoc,
            collection,
            getDocs,
            query,
            updateDoc,
            onSnapshot, // <-- NEW: Add onSnapshot
            where, // <-- NEW: Add where
            // NEW: Add storage functions to global fs object
            storage_ref: ref,
            uploadBytes,
            getDownloadURL
        };
        // --- END FIX ---


        // --- NEW: Helper function to format email as name ---
        const formatEmailAsName = (email) => {
            if (!email || email.indexOf('@') === -1) return 'User'; // Return 'User' if no email or invalid
            try {
                const namePart = email.split('@')[0];
                return namePart
                    .split(/[\._\-]/) // Split by dot, underscore, or dash
                    .map(part => part.charAt(0).toUpperCase() + part.slice(1)) // Capitalize each part
                    .join(' '); // Join with space
            } catch (e) {
                console.warn("Could not format email:", email, e);
                return 'User'; // Fallback
            }
        };
        // --- END NEW ---

        // --- NEW: Password Validation Helper ---
        const validatePassword = (password) => {
            if (password.length < 8) {
                return 'Password must be at least 8 characters long.';
            }
            // Check for at least one lowercase letter
            if (!/[a-z]/.test(password)) {
                return 'Password must contain at least one lowercase letter (a-z).';
            }
            // Check for at least one uppercase letter
            if (!/[A-Z]/.test(password)) {
                return 'Password must contain at least one uppercase letter (A-Z).';
            }
            // Check for at least one number
            if (!/\d/.test(password)) {
                return 'Password must contain at least one number (0-9).';
            }
            // Check for at least one special character
            if (!/[^a-zA-Z0-9]/.test(password)) {
                return 'Password must contain at least one special sign (e.g., !, @, #, $).';
            }
            return null; // Password is valid
        };
        // --- END NEW ---

        // --- FIX: Wait for DOM to be loaded before accessing elements ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- NEW: Define shield link and helper function globally (within DOMContentLoaded) ---
            const womenShieldLink = document.getElementById('nav-women-shield-link');

            const updateWomenShieldStatus = () => {
                if (!womenShieldLink) return;

                // Check auth status *without* relying on 'user' param from onAuthStateChanged
                // --- FIX: Removed '!window.auth.currentUser.isAnonymous' ---
                const isLoggedIn = window.auth.currentUser;
                const shieldActive = window.currentUserData?.womenShieldActive === true;

                if (isLoggedIn && shieldActive) {
                    // User is logged in AND shield is active
                    womenShieldLink.classList.remove('disabled');
                    womenShieldLink.classList.add('women-shield-blinking');
                } else {
                    // User is logged out OR shield is not active
                    womenShieldLink.classList.add('disabled');
                    womenShieldLink.classList.remove('women-shield-blinking'); // Remove blink
                    womenShieldLink.style.color = ''; // Let CSS class handle it
                }
            };
            // --- END NEW ---

            // --- AUTHENTICATION LOGIC ---

            // Get elements for showing auth state
            const navAuthLinks = document.getElementById('nav-auth-links'); // Container for Login/Sign Up
            const navUserInfo = document.getElementById('nav-user-info');
            const navUserPhoto = document.getElementById('nav-user-photo'); // <-- CHANGED from navUserInitial
            const navLogoutBtn = document.getElementById('nav-logout-btn');
            // const womenShieldLink = document.getElementById('nav-women-shield-link'); // <-- MOVED
            const communityLoginPrompt = document.getElementById('community-login-prompt');
            const communityRegisterView = document.getElementById('community-register-view');
            const communityProfileView = document.getElementById('community-profile-view');
            const communityProfileName = document.getElementById('community-profile-name');
            const communityRegisterTitle = document.getElementById('community-register-title');
            const communityRegisterSubtitle = document.getElementById('community-register-subtitle');

            // --- NEW: Role-specific action buttons ---
            const travelerActions = document.getElementById('traveler-actions');
            const driverActions = document.getElementById('driver-actions');
            const emergencyActions = document.getElementById('emergency-actions');
            const onDutyToggleContainer = document.getElementById('on-duty-toggle-container');
            const onDutyToggle = document.getElementById('on-duty-toggle');
            const onDutyStatusText = document.getElementById('on-duty-status-text');
            // --- END NEW ---

            // --- NEW: Profile Dropdown Elements ---
            const profileDropdownName = document.getElementById('profile-dropdown-name');
            const profileDropdownContact = document.getElementById('profile-dropdown-contact');
            // --- END NEW ---

            // --- NEW: Referral Modal Elements ---
            const referralCodeInput = document.getElementById('referral-code');
            const referralCopyBtn = document.getElementById('referral-copy-btn');
            // --- END NEW ---

            // --- NEW: Driver Ride Listener ---
            // Attaches a listener for rides assigned to this driver
            const attachAcceptedRideListener = () => {
                if (window.acceptedRideListener) {
                    window.acceptedRideListener(); // Detach old one
                }
                if (!window.db || !window.fs || !window.currentUserId) return;

                console.log(`Attaching accepted ride listener for driver: ${window.currentUserId}`);

                const q = window.fs.query(
                    window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'ride-requests'),
                    window.fs.where('driverId', '==', window.currentUserId),
                    window.fs.where('status', '==', 'accepted') // <-- Listen for 'accepted' status
                );

                window.acceptedRideListener = window.fs.onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        console.log("No accepted rides found.");
                        return;
                    }

                    snapshot.forEach(doc => {
                        const ride = doc.data();
                        console.log("Found accepted ride:", doc.id);

                        // Check if we are already handling this ride
                        if (window.currentRideRequestId === doc.id) return;

                        // New ride assigned!
                        window.currentRideRequestId = doc.id;

                        // Close other modals
                        document.getElementById('ride-requests-modal')?.classList.remove('active');

                        // Show pickup modal
                        const modal = document.getElementById('new-pickup-modal');
                        if (modal) {
                            modal.querySelector('#pickup-traveler-name').textContent = ride.travelerName || 'Traveler';
                            modal.querySelector('#pickup-traveler-from').textContent = ride.from || 'Unknown';
                            modal.querySelector('#pickup-traveler-to').textContent = ride.to || 'Unknown';
                            modal.classList.add('active');
                        }

                        // Start sending location
                        startSendingDriverLocation(doc.id);
                    });
                }, (error) => {
                    console.error("Error listening for accepted rides:", error);
                });
            };

            // Detaches the listener
            const detachAcceptedRideListener = () => {
                if (window.acceptedRideListener) {
                    window.acceptedRideListener(); // Call unsubscribe
                    window.acceptedRideListener = null;
                    console.log("Detached accepted ride listener.");
                }
            };
            // --- END NEW ---

            // --- NEW: Central UI Update Function ---
            const updateCommunityView = () => {
                const user = window.auth.currentUser;
                const userData = window.currentUserData;
                const userRole = userData.role || 'unknown';
                const userName = userData.name || (user ? formatEmailAsName(user.email) : 'Guest');

                // --- 1. Update Nav Bar ---
                if (navUserPhoto) {
                    // Update photo or initial
                    if (userData.photoUrl) {
                        navUserPhoto.src = userData.photoUrl;
                    } else {
                        // Use a placeholder with the first letter of the name
                        const initial = userName.charAt(0).toUpperCase() || 'G';
                        navUserPhoto.src = `https://placehold.co/40x40/ccc/eee?text=${initial}`;
                    }
                    // Update role class
                    navUserPhoto.parentElement.classList.remove('profile-role-traveler', 'profile-role-driver', 'profile-role-emergency');
                    if (userRole === 'traveler') navUserPhoto.parentElement.classList.add('profile-role-traveler');
                    else if (userRole === 'driver') navUserPhoto.parentElement.classList.add('profile-role-driver');
                    else if (userRole === 'emergency') navUserPhoto.parentElement.classList.add('profile-role-emergency');
                }

                // --- 2. Update Profile Dropdown ---
                if (profileDropdownName) profileDropdownName.textContent = userName;
                if (profileDropdownContact) profileDropdownContact.textContent = userData.phone || userData.email || 'No contact info';

                // --- 3. Update Referral Code ---
                if (referralCodeInput && window.currentUserId) {
                    referralCodeInput.value = `SR-${window.currentUserId.substring(0, 8).toUpperCase()}`;
                } else if (referralCodeInput) {
                    referralCodeInput.value = 'LOGIN-TO-SEE-CODE';
                }

                // --- 4. Update Women Shield Status ---
                updateWomenShieldStatus();

                // --- 5. Update Main Community Box View ---
                // Hide all first
                if (communityLoginPrompt) communityLoginPrompt.style.display = 'none';
                if (communityRegisterView) communityRegisterView.style.display = 'none';
                if (communityProfileView) communityProfileView.style.display = 'none';
                // Hide all role actions
                if (travelerActions) travelerActions.style.display = 'none';
                if (driverActions) driverActions.style.display = 'none';
                if (emergencyActions) emergencyActions.style.display = 'none';
                if (onDutyToggleContainer) onDutyToggleContainer.style.display = 'none';

                if (!user || user.isAnonymous) {
                    // --- View 1: Logged OUT (or Guest) ---
                    if (communityLoginPrompt) communityLoginPrompt.style.display = 'block';
                } else if (userRole === 'unknown' || (userRole !== 'guest' && typeof userData.gender === 'undefined')) {
                    // --- View 2: Logged IN, needs role (or needs gender) ---
                    if (communityRegisterView) communityRegisterView.style.display = 'block';

                    // --- NEW: Check if gender is missing ---
                    if (userRole !== 'unknown' && typeof userData.gender === 'undefined') {
                        if (communityRegisterTitle) communityRegisterTitle.innerHTML = `<i class="fas fa-venus-mars"></i> Complete Your Profile`;
                        if (communityRegisterSubtitle) communityRegisterSubtitle.textContent = 'Please provide your gender to complete your registration. This is required for safety features.';
                        // Hide other roles
                        if (userRole === 'traveler') {
                            document.querySelector('.reg-card.driver').style.display = 'none';
                            document.querySelector('.reg-card.emergency').style.display = 'none';
                        } else if (userRole === 'driver') {
                            document.querySelector('.reg-card.traveler').style.display = 'none';
                            document.querySelector('.reg-card.emergency').style.display = 'none';
                        } else if (userRole === 'emergency') {
                            document.querySelector('.reg-card.traveler').style.display = 'none';
                            document.querySelector('.reg-card.driver').style.display = 'none';
                        }
                    } else {
                        // Reset to default
                        if (communityRegisterTitle) communityRegisterTitle.innerHTML = `<i class="fas fa-users"></i> Join Our Safety Community`;
                        if (communityRegisterSubtitle) communityRegisterSubtitle.textContent = 'Register as a community driver or an emergency responder to get localized alerts and contribute to safer roads for everyone.';
                        document.querySelector('.reg-card.driver').style.display = 'block';
                        document.querySelector('.reg-card.traveler').style.display = 'block';
                        document.querySelector('.reg-card.emergency').style.display = 'block';
                    }
                    // --- END NEW ---
                } else {
                    // --- View 3: Logged IN, Role is Set ---
                    if (communityProfileView) {
                        communityProfileView.style.display = 'block';
                        // Set profile name
                        if (communityProfileName) communityProfileName.textContent = userName;
                        // Set profile card class
                        communityProfileView.className = 'community-box'; // Reset
                        communityProfileView.classList.add(`profile-view-${userRole}`);

                        // Show correct actions
                        if (userRole === 'traveler') {
                            if (travelerActions) travelerActions.style.display = 'flex';
                        } else if (userRole === 'driver') {
                            if (driverActions) driverActions.style.display = 'flex';
                            if (onDutyToggleContainer) onDutyToggleContainer.style.display = 'flex';
                            if (onDutyToggle) onDutyToggle.checked = userData.onDuty || false;
                            updateOnDutyStatus(userData.onDuty || false);
                        } else if (userRole === 'emergency') {
                            if (emergencyActions) emergencyActions.style.display = 'flex';
                            if (onDutyToggleContainer) onDutyToggleContainer.style.display = 'flex';
                            if (onDutyToggle) onDutyToggle.checked = userData.onDuty || false;
                            updateOnDutyStatus(userData.onDuty || false);
                        }
                    }
                }
            };
            // --- END NEW Central UI Update Function ---

            // --- NEW: On Duty Toggle Logic ---
            const updateOnDutyStatus = (isOnDuty) => {
                if (!onDutyStatusText) return;
                if (isOnDuty) {
                    onDutyStatusText.textContent = 'On Duty';
                    onDutyStatusText.classList.add('on-duty');
                    onDutyStatusText.classList.remove('off-duty');
                } else {
                    onDutyStatusText.textContent = 'Off Duty';
                    onDutyStatusText.classList.add('off-duty');
                    onDutyStatusText.classList.remove('on-duty');
                }
            };

            if (onDutyToggle) {
                onDutyToggle.addEventListener('change', async (e) => {
                    const isOnDuty = e.target.checked;
                    updateOnDutyStatus(isOnDuty);

                    // Update in Firestore
                    if (window.currentUserId && window.db && window.fs) {
                        try {
                            const userDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'users', window.currentUserId);
                            await window.fs.updateDoc(userDocRef, {
                                onDuty: isOnDuty
                            });
                            // Update local data
                            window.currentUserData.onDuty = isOnDuty;

                            // --- NEW: Attach/Detach listeners based on duty status ---
                            if (isOnDuty) {
                                // Attach listeners
                                if (window.currentUserData.role === 'driver') {
                                    attachAcceptedRideListener(); // Listen for assigned rides
                                }
                            } else {
                                // Detach listeners
                                if (window.currentUserData.role === 'driver') {
                                    detachAcceptedRideListener();
                                }
                                // Detach other listeners if needed
                                if (window.rideRequestsListener) {
                                    window.rideRequestsListener();
                                    window.rideRequestsListener = null;
                                }
                                if (window.activeAlertsListener) {
                                    window.activeAlertsListener();
                                    window.activeAlertsListener = null;
                                }
                            }
                            // --- END NEW ---

                        } catch (error) {
                            console.error("Error updating on-duty status:", error);
                            // Revert toggle on error
                            e.target.checked = !isOnDuty;
                            updateOnDutyStatus(!isOnDuty);
                            window.showAlert('Error', `Could not update status: ${error.message}`, 'error');
                        }
                    }
                });
            }
            // --- END NEW ---

            // Listen for authentication state changes (login/logout)
            onAuthStateChanged(auth, async (user) => {

                // --- REMOVED: Old click listener setup for Women Shield ---

                if (user) {
                    // User is signed in
                    console.log('User logged in:', user.email);
                    navAuthLinks.style.display = 'none'; // Hide Login/Sign Up
                    navUserInfo.style.display = 'flex';
                    // navUserEmail.textContent = user.email; // <-- REMOVED

                    // --- LOGIC TO FETCH USER ROLE AND NAME ---
                    let userRole = 'unknown';
                    let userName = formatEmailAsName(user.email); // Default to formatted email
                    const userId = user.uid;
                    const userDocRef = doc(db, 'artifacts', appId, 'users', userId);

                    window.currentUserId = userId; // <-- NEW: Set global userId

                    let userData = {}; // --- FIX 3: Initialize userData ---
                    let photoUrl; // <-- NEW: Declare photoUrl here

                    try {
                        const userDoc = await getDoc(userDocRef);
                        if (userDoc.exists()) {
                            userData = userDoc.data(); // --- FIX 3: Assign userData here ---
                            userRole = userData.role || 'unknown';

                            // --- NEW FIX: Check if gender is missing for an existing user ---
                            const isProfileIncomplete = (userRole !== 'guest' && userRole !== 'unknown' && typeof userData.gender === 'undefined');
                            // --- END NEW FIX ---

                            // Get name based on role
                            if (userRole === 'driver') userName = userData.name || formatEmailAsName(user.email);
                            else if (userRole === 'traveler') userName = userData.name || formatEmailAsName(user.email);
                            else if (userRole === 'emergency') userName = userData.operatorName || formatEmailAsName(user.email);
                            else userName = user.isAnonymous ? 'Guest' : formatEmailAsName(user.email); // No role yet or anonymous

                            // --- NEW: Set photoUrl from userData ---
                            photoUrl = userData.photoUrl;
                            // --- END NEW ---

                            // --- NEW: Seed Demo Data (Rides & Rewards) ---
                            if (!userData.demoDataSeeded && !user.isAnonymous) {
                                console.log("Seeding demo data for user...");
                                const ridesColRef = collection(db, 'artifacts', appId, 'users', userId, 'rides');
                                await addDoc(ridesColRef, {
                                    location: "City Center to Airport",
                                    date: "2025-10-28T15:30:00Z",
                                    driver: "Ramesh Kumar",
                                    price: 450,
                                    type: "car"
                                });
                                await addDoc(ridesColRef, {
                                    location: "Sector 14 to Cyber Hub",
                                    date: "2025-10-27T09:00:00Z",
                                    driver: "Priya Singh",
                                    price: 120,
                                    type: "motorcycle"
                                });

                                const rewardsColRef = collection(db, 'artifacts', appId, 'users', userId, 'rewards');
                                await addDoc(rewardsColRef, {
                                    title: "50% Off First Ride",
                                    description: "Valid for your first ride. Expires in 7 days.",
                                    icon: "fa-percentage",
                                    claimed: false
                                });
                                await addDoc(rewardsColRef, {
                                    title: "₹25 Wallet Credit",
                                    description: "From 'Refer a Friend' bonus.",
                                    icon: "fa-rupee-sign",
                                    claimed: true
                                });

                                // Mark as seeded
                                await updateDoc(userDocRef, { demoDataSeeded: true });
                                userData.demoDataSeeded = true; // Update local copy
                            }
                            // --- END Seed Demo Data ---


                        } else {
                            if (!user.isAnonymous) {
                                console.warn("User document not found for UID:", userId, "Creating one.");
                                // This is a new user who just signed up, create a base doc
                                await setDoc(userDocRef, {
                                    email: user.email,
                                    role: 'unknown',
                                    createdAt: new Date().toISOString(),
                                    walletBalance: 0,
                                    onDuty: false // <-- NEW: Add onDuty status
                                });
                                userRole = 'unknown';
                                userData = { role: 'unknown', email: user.email, walletBalance: 0, onDuty: false };
                            } else {
                                userRole = 'guest';
                                userName = 'Guest';
                                userData = { role: 'guest', name: 'Guest' };
                            }
                        }

                        window.currentUserData = userData; // <-- NEW: Set global userData

                        // --- NEW: Populate Profile Dropdown ---
                        // --- FIX 3: This code is now safe because userData is always an object ---
                        // --- REMOVED: All profile/referral/photo logic moved to updateCommunityView() ---
                        // --- END NEW ---

                        // --- NEW: Populate Referral Code ---
                        // --- REMOVED: All profile/referral/photo logic moved to updateCommunityView() ---
                        // --- END NEW ---

                    } catch (error) {
                        console.error("Error fetching user document:", error);
                        window.currentUserData = { role: 'guest' }; // Set fallback
                    }

                    // --- NEW: Populate Profile Dropdown ---
                    // --- REMOVED: All profile/referral/photo logic moved to updateCommunityView() ---
                    // --- END NEW LOGIC ---

                    // --- NEW: Call helper function to set Women Shield status ---
                    // --- REMOVED: updateWomenShieldStatus(); ---
                    // --- END NEW ---

                    // --- CALL THE NEW CENTRAL UI UPDATE FUNCTION ---
                    updateCommunityView();
                    // --- END CALL ---

                    // --- NEW LOGIC TO SHOW CORRECT COMMUNITY VIEW ---
                    // --- HIDE ALL ROLE-SPECIFIC ELEMENTS FIRST ---
                    // --- ALL LOGIC FROM HERE... ---
                    // ...
                    // ...
                    // ...
                    // --- ...TO HERE, HAS BEEN MOVED to updateCommunityView() ---
                    // --- END NEW ---

                    // --- NEW: Populate Modals ---
                    if (window.populateWallet) window.populateWallet();
                    if (window.populateRides) window.populateRides();
                    if (window.populateRewards) window.populateRewards();
                    // --- END NEW ---

                    // --- NEW: Attach driver listener if on duty ---
                    if (window.currentUserData.role === 'driver' && window.currentUserData.onDuty) {
                        attachAcceptedRideListener();
                    }
                    // --- END NEW ---

                } else {
                    // User is signed out
                    console.log('User logged out');
                    navAuthLinks.style.display = 'flex'; // Show Login/Sign Up
                    navUserInfo.style.display = 'none';

                    // --- NEW: Reset global user data ---
                    window.currentUserId = null;
                    window.currentUserData = { role: 'guest' }; // Set fallback
                    // --- END NEW ---

                    // --- CALL THE NEW CENTRAL UI UPDATE FUNCTION ---
                    updateCommunityView(); // This will show the logged-out view
                    // --- END CALL ---

                    // --- NEW: Detach listeners ---
                    detachAcceptedRideListener();
                    // --- NEW: Detach traveler/bid listeners ---
                    if (window.rideBidsListener) window.rideBidsListener();
                    if (window.tripStatusListener) window.tripStatusListener();
                    stopSendingDriverLocation(); // Stop sending location if driver
                    window.rideBidsListener = null;
                    window.tripStatusListener = null;
                    window.currentRideRequestId = null;
                    // --- END NEW ---
                }
            });

            // Sign in with custom token if available, otherwise anonymously
            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error during initial authentication:", error);
                }
            })();


            // --- Get all modal elements ---
            const regModal = document.getElementById('reg-modal');
            const regCloseBtn = regModal.querySelector('.reg-form-close');

            // Form Wrappers
            const loginFormWrapper = document.getElementById('login-form-wrapper');
            const signupFormWrapper = document.getElementById('signup-form-wrapper'); // NEW
            const driverFormWrapper = document.getElementById('driver-form-wrapper');
            const emergencyFormWrapper = document.getElementById('emergency-form-wrapper');
            const travelerFormWrapper = document.getElementById('traveler-form-wrapper');

            // Forms
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form'); // NEW
            const driverForm = document.getElementById('driver-registration-form');
            const emergencyForm = document.getElementById('emergency-registration-form');
            const travelerForm = document.getElementById('traveler-registration-form');

            // Success Messages
            const driverSuccess = document.getElementById('driver-success-message');
            const emergencySuccess = document.getElementById('emergency-success-message');
            const travelerSuccess = document.getElementById('traveler-success-message');

            // Error Messages
            const loginError = document.getElementById('login-error');
            const signupError = document.getElementById('signup-error'); // NEW
            const driverRegError = document.getElementById('driver-reg-error');
            const travelerRegError = document.getElementById('traveler-reg-error');
            const emergencyRegError = document.getElementById('emergency-reg-error');

            // Map Containers
            const driverMapContainer = document.getElementById('driver-map-container');
            const emergencyMapContainer = document.getElementById('emergency-map-container');

            // --- NEW: Photo File Holders ---
            let driverPhotoFile = null;
            let travelerPhotoFile = null;
            let emergencyPhotoFile = null;
            // --- END NEW ---

            // --- Modal Control Functions ---
            const allFormWrappers = [loginFormWrapper, signupFormWrapper, driverFormWrapper, emergencyFormWrapper, travelerFormWrapper];
            const allSuccessMessages = [driverSuccess, emergencySuccess, travelerSuccess];
            const allErrorMessages = [loginError, signupError, driverRegError, travelerRegError, emergencyRegError];

            // Reset all modal content
            const resetModalForms = () => {
                allFormWrappers.forEach(form => {
                    if (form) form.style.display = 'none';
                });
                allSuccessMessages.forEach(msg => {
                    if (msg) msg.style.display = 'none';
                });
                allErrorMessages.forEach(msg => {
                    if (msg) {
                        msg.style.display = 'none';
                        msg.textContent = '';
                    }
                });

                // Reset the forms themselves
                if (loginForm) loginForm.reset();
                if (signupForm) signupForm.reset(); // NEW
                if (driverForm) driverForm.reset();
                if (emergencyForm) emergencyForm.reset();
                if (travelerForm) travelerForm.reset();

                // --- NEW: Reset photo previews ---
                const previews = document.querySelectorAll('.photo-preview');
                const icons = document.querySelectorAll('.upload-icon');
                previews.forEach(p => p.classList.remove('active'));
                icons.forEach(i => i.classList.remove('hidden'));
                driverPhotoFile = null;
                travelerPhotoFile = null;
                emergencyPhotoFile = null;
                // --- END NEW ---

                if (driverMapContainer) {
                    driverMapContainer.style.display = 'none';
                    driverMapContainer.innerHTML = '';
                }
                if (emergencyMapContainer) {
                    emergencyMapContainer.style.display = 'none';
                    emergencyMapContainer.innerHTML = '';
                }

                // --- NEW: Reset gender buttons ---
                document.querySelectorAll('.gender-btn.active').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('input[name="gender"]').forEach(input => input.value = '');
                // --- END NEW ---
            };

            // Close Modal
            const closeModal = () => {
                if (regModal) regModal.classList.remove('active');
                setTimeout(resetModalForms, 300);
            };

            if (regCloseBtn) regCloseBtn.addEventListener('click', closeModal);
            if (regModal) regModal.addEventListener('click', (e) => {
                if (e.target === regModal) {
                    closeModal();
                }
            });

            // --- NEW: Gender Button Logic ---
            const setupGenderButtons = (groupId, inputId) => {
                const group = document.getElementById(groupId);
                const input = document.getElementById(inputId);
                if (!group || !input) return;

                const buttons = group.querySelectorAll('.gender-btn');
                buttons.forEach(button => {
                    button.addEventListener('click', () => {
                        // Remove active from all buttons in this group
                        buttons.forEach(btn => btn.classList.remove('active'));
                        // Add active to the clicked one
                        button.classList.add('active');
                        // Set the hidden input's value
                        input.value = button.dataset.value;
                    });
                });
            };

            setupGenderButtons('traveler-gender-group', 'travelerGender');
            setupGenderButtons('driver-gender-group', 'driverGender');
            setupGenderButtons('emergency-gender-group', 'emergencyGender');
            // --- END NEW ---

            // --- EVENT LISTENERS ---

            // 1. Listen for clicks on "Login" button in nav
            const navLoginBtn = document.getElementById('nav-login-btn');
            if (navLoginBtn) {
                navLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    resetModalForms();
                    if (loginFormWrapper) loginFormWrapper.style.display = 'block';
                    if (regModal) regModal.classList.add('active');
                });
            }

            // 2. NEW: Listen for clicks on "Sign Up" button in nav
            const navSignupBtn = document.getElementById('nav-signup-btn');
            if (navSignupBtn) {
                navSignupBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    resetModalForms();
                    if (signupFormWrapper) signupFormWrapper.style.display = 'block';
                    if (regModal) regModal.classList.add('active');
                });
            }

            // 3. Listen for clicks on the "Logout" button
            if (navLogoutBtn) {
                navLogoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    try {
                        await signOut(auth);
                    } catch (error) {
                        console.error("Error signing out:", error);
                    }
                });
            }

            // 4. Listen for clicks on the role registration cards (Driver, Traveler, Emergency)
            document.querySelectorAll('.reg-card[data-form-type]').forEach(card => {
                card.addEventListener('click', () => {
                    resetModalForms();
                    const formType = card.dataset.formType;

                    if (formType === 'driver') {
                        if (driverFormWrapper) driverFormWrapper.style.display = 'block';
                    } else if (formType === 'emergency') {
                        if (emergencyFormWrapper) emergencyFormWrapper.style.display = 'block';
                    } else if (formType === 'traveler') {
                        if (travelerFormWrapper) travelerFormWrapper.style.display = 'block';
                    }

                    if (regModal) regModal.classList.add('active');
                });
            });

            // --- FORM SUBMISSION LOGIC ---

            // 1. Handle Login Form Submission
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = loginForm.loginEmail.value;
                    const password = loginForm.loginPassword.value;
                    if (loginError) loginError.style.display = 'none';

                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        // Auth listener (onAuthStateChanged) will handle UI changes
                        closeModal();
                    } catch (error) {
                        console.error("Login Error:", error.message);
                        if (loginError) {
                            loginError.textContent = `Login Failed: ${error.message}`;
                            loginError.style.display = 'block';
                        }
                    }
                });
            }

            // 2. NEW: Handle Sign Up Form Submission
            if (signupForm) {
                signupForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = signupForm.signupEmail.value;
                    const password = signupForm.signupPassword.value;
                    const confirmPassword = signupForm.signupConfirmPassword.value;
                    if (signupError) signupError.style.display = 'none';

                    // --- MODIFIED: New Password Validation ---
                    const passwordError = validatePassword(password);
                    if (passwordError) {
                        if (signupError) {
                            signupError.textContent = passwordError;
                            signupError.style.display = 'block';
                        }
                        return;
                    }
                    // --- END MODIFICATION ---

                    if (password !== confirmPassword) {
                        if (signupError) {
                            signupError.textContent = 'Passwords do not match.';
                            signupError.style.display = 'block';
                        }
                        return;
                    }

                    try {
                        // Step 1: Create user in Auth
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        const userId = user.uid;

                        // Step 2: Create a basic user doc in Firestore with 'unknown' role
                        // onAuthStateChanged will see this 'unknown' role and prompt user to select one
                        await setDoc(doc(db, 'artifacts', appId, 'users', userId), {
                            email: email,
                            role: 'unknown',
                            createdAt: new Date().toISOString(),
                            walletBalance: 0,
                            onDuty: false // <-- NEW: Add onDuty status
                        });

                        // Auth listener (onAuthStateChanged) will handle UI changes
                        closeModal();

                    } catch (error) {
                        console.error("Sign Up Error:", error.message);
                        if (signupError) {
                            signupError.textContent = `Sign Up Failed: ${error.message}`;
                            signupError.style.display = 'block';
                        }
                    }
                });
            }

            // 3. Handle Driver Registration (Role Completion)
            if (driverForm) {
                driverForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (driverRegError) driverRegError.style.display = 'none';

                    const user = auth.currentUser;
                    if (!user) {
                        if (driverRegError) {
                            driverRegError.textContent = 'You are not logged in. Please log in first.';
                            driverRegError.style.display = 'block';
                        }
                        return;
                    }

                    const submitBtn = driverForm.querySelector('.submit-btn');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Registering...';

                    const formData = new FormData(driverForm);
                    const data = Object.fromEntries(formData.entries());
                    // --- REMOVED driverPhoto from data destructuring ---
                    const { driverName, driverPhone, vehicleType, licensePlate, vehicleMake, vehicleModel, baseLocation, gender } = data; // <-- FIX: Changed 'driverDestination' to 'baseLocation' & ADDED gender

                    try {
                        const userId = user.uid;
                        let photoUrl = null; // <-- NEW

                        // --- NEW: Upload photo if it exists ---
                        if (window.driverPhotoFile) { // <-- Use global file var
                            if (driverRegError) {
                                driverRegError.textContent = 'Uploading photo...'; // Show status
                                driverRegError.style.display = 'block';
                            }
                            const photoRef = window.fs.storage_ref(window.storage, `artifacts/${appId}/user_photos/${userId}/profile.jpg`);
                            const snapshot = await window.fs.uploadBytes(photoRef, window.driverPhotoFile); // <-- Use global file var
                            photoUrl = await window.fs.getDownloadURL(snapshot.ref);
                            if (driverRegError) driverRegError.textContent = 'Photo uploaded!'; // Update status
                        }
                        // --- END NEW ---

                        const userData = {
                            email: user.email, // Get email from the logged-in user
                            name: driverName,
                            phone: driverPhone,
                            role: 'driver', // Set the role
                            gender: gender, // <-- NEW
                            photoUrl: photoUrl, // <-- CHANGED from photoFilename
                            vehicleType: vehicleType,
                            licensePlate: licensePlate,
                            vehicleMake: vehicleMake,
                            vehicleModel: vehicleModel,
                            baseLocation: baseLocation, // <-- MODIFIED: Was 'destination'
                            onDuty: false, // <-- NEW
                            createdAt: new Date().toISOString(), // Or update, but new timestamp is fine
                            womenShieldActive: gender === 'female' // <-- ADDED
                        };

                        await setDoc(doc(db, 'artifacts', appId, 'users', userId), userData, { merge: true });

                        // --- NEW: Update local data and UI immediately ---
                        window.currentUserData = { ...window.currentUserData, ...userData }; // <-- MODIFIED: Merge all new data
                        updateCommunityView(); // <-- MODIFIED: Call central UI update function
                        // --- END NEW ---

                        // --- NEW: Reset file and preview ---
                        window.driverPhotoFile = null; // <-- Use global file var
                        const driverPreview = document.getElementById('driver-photo-preview');
                        const driverIcon = document.getElementById('driver-photo-icon');
                        if (driverPreview) driverPreview.classList.remove('active');
                        if (driverIcon) driverIcon.classList.remove('hidden');
                        // --- END NEW ---

                        // Show success
                        if (driverFormWrapper) driverFormWrapper.style.display = 'none';
                        if (driverSuccess) driverSuccess.style.display = 'block';
                        setTimeout(closeModal, 2500);

                    } catch (error) {
                        console.error("Driver Registration Error:", error.message);
                        if (driverRegError) {
                            driverRegError.textContent = `Registration Failed: ${error.message}`;
                            driverRegError.style.display = 'block';
                        }
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Register Driver';
                    }
                });
            }

            // 4. Handle Traveler Registration (Role Completion)
            if (travelerForm) {
                travelerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (travelerRegError) travelerRegError.style.display = 'none';

                    const user = auth.currentUser;
                    if (!user) {
                        if (travelerRegError) {
                            travelerRegError.textContent = 'You are not logged in. Please log in first.';
                            travelerRegError.style.display = 'block';
                        }
                        return;
                    }

                    const submitBtn = travelerForm.querySelector('.submit-btn');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Registering...';

                    const formData = new FormData(travelerForm);
                    const data = Object.fromEntries(formData.entries());
                    // --- REMOVED travelerPhoto from data destructuring ---
                    const { travelerName, travelerPhone, travelerLocation, gender } = data; // <-- ADDED gender

                    try {
                        const userId = user.uid;
                        let photoUrl = null; // <-- NEW

                        // --- NEW: Upload photo if it exists ---
                        if (window.travelerPhotoFile) { // <-- Use global file var
                            if (travelerRegError) {
                                travelerRegError.textContent = 'Uploading photo...'; // Show status
                                travelerRegError.style.display = 'block';
                            }
                            const photoRef = window.fs.storage_ref(window.storage, `artifacts/${appId}/user_photos/${userId}/profile.jpg`);
                            const snapshot = await window.fs.uploadBytes(photoRef, window.travelerPhotoFile); // <-- Use global file var
                            photoUrl = await window.fs.getDownloadURL(snapshot.ref);
                            if (travelerRegError) travelerRegError.textContent = 'Photo uploaded!'; // Update status
                        }
                        // --- END NEW ---

                        const userData = {
                            email: user.email, // Get email from logged-in user
                            name: travelerName,
                            phone: travelerPhone,
                            role: 'traveler', // Set the role
                            gender: gender, // <-- NEW
                            photoUrl: photoUrl, // <-- CHANGED from photoFilename
                            defaultLocation: travelerLocation, // <-- MODIFIED: Kept as defaultLocation
                            createdAt: new Date().toISOString(),
                            womenShieldActive: gender === 'female' // <-- ADDED
                        };

                        await setDoc(doc(db, 'artifacts', appId, 'users', userId), userData, { merge: true });

                        // --- NEW: Update local data and UI immediately ---
                        window.currentUserData = { ...window.currentUserData, ...userData }; // <-- MODIFIED: Merge all new data
                        updateCommunityView(); // <-- MODIFIED: Call central UI update function
                        // --- END NEW ---

                        // --- NEW: Reset file and preview ---
                        window.travelerPhotoFile = null; // <-- Use global file var
                        const travelerPreview = document.getElementById('traveler-photo-preview');
                        const travelerIcon = document.getElementById('traveler-photo-icon');
                        if (travelerPreview) travelerPreview.classList.remove('active');
                        if (travelerIcon) travelerIcon.classList.remove('hidden');
                        // --- END NEW ---

                        if (travelerFormWrapper) travelerFormWrapper.style.display = 'none';
                        if (travelerSuccess) travelerSuccess.style.display = 'block';
                        setTimeout(closeModal, 2500);

                    } catch (error) {
                        console.error("Traveler Registration Error:", error.message);
                        if (travelerRegError) {
                            travelerRegError.textContent = `Registration Failed: ${error.message}`;
                            travelerRegError.style.display = 'block';
                        }
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Register as Traveler';
                    }
                });
            }

            // 5. Handle Emergency Registration (Role Completion)
            if (emergencyForm) {
                emergencyForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (emergencyRegError) emergencyRegError.style.display = 'none';

                    const user = auth.currentUser;
                    if (!user) {
                        if (emergencyRegError) {
                            emergencyRegError.textContent = 'You are not logged in. Please log in first.';
                            emergencyRegError.style.display = 'block';
                        }
                        return;
                    }

                    const submitBtn = emergencyForm.querySelector('.submit-btn');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Registering...';

                    const formData = new FormData(emergencyForm);
                    const data = Object.fromEntries(formData.entries());
                    // --- REMOVED servicePhoto from data destructuring ---
                    const { serviceType, serviceId, serviceName, servicePhone, serviceVehicleId, serviceVehicleType, baseLocation, gender } = data; // <-- MODIFIED: Was 'emergencyDestination' & ADDED gender

                    try {
                        const userId = user.uid;
                        let photoUrl = null; // <-- NEW

                        // --- NEW: Upload photo if it exists ---
                        if (window.emergencyPhotoFile) { // <-- Use global file var
                            if (emergencyRegError) {
                                emergencyRegError.textContent = 'Uploading photo...'; // Show status
                                emergencyRegError.style.display = 'block';
                            }
                            const photoRef = window.fs.storage_ref(window.storage, `artifacts/${appId}/user_photos/${userId}/profile.jpg`);
                            const snapshot = await window.fs.uploadBytes(photoRef, window.emergencyPhotoFile); // <-- Use global file var
                            photoUrl = await window.fs.getDownloadURL(snapshot.ref);
                            if (emergencyRegError) emergencyRegError.textContent = 'Photo uploaded!'; // Update status
                        }
                        // --- END NEW ---

                        const serviceData = {
                            email: user.email, // Get email from logged-in user
                            operatorName: serviceName,
                            phone: servicePhone,
                            role: 'emergency', // Set the role
                            gender: gender, // <-- NEW
                            photoUrl: photoUrl, // <-- CHANGED from photoFilename
                            serviceType: serviceType,
                            serviceId: serviceId,
                            vehicleId: serviceVehicleId,
                            vehicleType: serviceVehicleType,
                            baseLocation: baseLocation, // <-- MODIFIED: Was 'destination'
                            onDuty: false, // <-- NEW
                            bestRoute: formData.has('bestRoute'),
                            createdAt: new Date().toISOString(),
                            womenShieldActive: gender === 'female' // <-- ADDED
                        };

                        await setDoc(doc(db, 'artifacts', appId, 'users', userId), serviceData, { merge: true });

                        // --- NEW: Update local data and UI immediately ---
                        window.currentUserData = { ...window.currentUserData, ...serviceData }; // <-- MODIFIED: Merge all new data
                        updateCommunityView(); // <-- MODIFIED: Call central UI update function
                        // --- END NEW ---

                        // --- NEW: Reset file and preview ---
                        window.emergencyPhotoFile = null; // <-- Use global file var
                        const emergencyPreview = document.getElementById('emergency-photo-preview');
                        const emergencyIcon = document.getElementById('emergency-photo-icon');
                        if (emergencyPreview) emergencyPreview.classList.remove('active');
                        if (emergencyIcon) emergencyIcon.classList.remove('hidden');
                        // --- END NEW ---

                        if (emergencyFormWrapper) emergencyFormWrapper.style.display = 'none';
                        if (emergencySuccess) emergencySuccess.style.display = 'block';
                        setTimeout(closeModal, 2500);

                    } catch (error) {
                        console.error("Emergency Registration Error:", error.message);
                        if (emergencyRegError) {
                            emergencyRegError.textContent = `Registration Failed: ${error.message}`;
                            emergencyRegError.style.display = 'block';
                        }
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Register Service';
                    }
                });
            }
        }); // --- End of DOMContentLoaded ---
    </script>

    <!-- === STYLES === -->
    <style>
        :root {
            --primary-color: #ff4d4d;
            --secondary-color: #222;
            --light-bg: #f4f4f4;
            --card-bg: #fff;
            --text-color: #333;
            --hover-color: #e63939;
            --dark-red-outline: #cc0000;
            --transition-speed: 0.3s;
            --footer-bg: #1a1a1a;
            --footer-text: #fff;
            --footer-accent: #ffcc00;
            --footer-hover: #e6b800;
            --dark-bg: #1a1a1a;
            --light-text: #fff;
            --accent-color: #ffcc00;
            --accent-hover: #e6b800;
            --border-color: #444;

            /* --- NEW Role Colors --- */
            --traveler-color: #007bff;
            --traveler-hover: #0056b3;
            --traveler-bg: #f0f7ff;

            --driver-color: #4CAF50;
            --driver-hover: #45a049;
            --driver-bg: #f0fff0;

            --emergency-color: var(--primary-color);
            --emergency-hover: var(--hover-color);
            --emergency-bg: #fff0f0;
            /* --- END NEW --- */
        }

        /* --- NEW: Bidding & Tracking Modal Styles --- */
        .bids-list-container,
        .tracking-map-container {
            margin-top: 20px;
        }

        .bids-list {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .bid-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }

        .bid-item .driver-info {
            flex-grow: 1;
        }

        .bid-item .driver-info p {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .bid-item .driver-info span {
            font-size: 0.9em;
            color: #666;
            display: block;
        }

        .bid-item .bid-amount {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--driver-color);
            margin: 0 10px;
        }

        .bid-item .accept-bid-btn {
            background: var(--traveler-color);
            color: white;
            border: none;
            padding: 10px 15px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .bid-item .accept-bid-btn:hover {
            background: var(--traveler-hover);
        }

        #tracking-map {
            width: 100%;
            height: 300px;
            background: #eee;
            border-radius: 8px;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #777;
        }

        #tracking-map iframe {
            width: 100%;
            height: 100%;
            border: 0;
            border-radius: 8px;
        }

        #tracking-driver-info {
            padding: 15px;
            background: var(--driver-bg);
            border: 1px solid var(--driver-color);
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }

        #tracking-driver-info h4 {
            margin: 0 0 5px;
            color: var(--driver-color);
            font-size: 1.2em;
        }

        #tracking-driver-info p {
            margin: 0;
            color: #333;
        }

        #new-pickup-modal .details-grid {
            text-align: left;
            margin: 20px 0;
            font-size: 1.1em;
        }

        #new-pickup-modal .details-grid p {
            margin: 10px 0;
            color: #555;
        }

        #new-pickup-modal .details-grid strong {
            color: var(--secondary-color);
            display: inline-block;
            width: 80px;
        }

        #new-pickup-modal .pickup-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        #new-pickup-modal .pickup-actions .submit-btn {
            flex: 1;
            margin: 0;
        }

        #end-ride-btn {
            background: var(--driver-color);
        }

        #end-ride-btn:hover {
            background: var(--driver-hover);
        }

        #cancel-ride-btn {
            background: #777;
        }

        #cancel-ride-btn:hover {
            background: #555;
        }

        #ride-complete-modal .ride-summary {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 25px 0;
        }

        #ride-complete-modal .ride-summary p {
            font-size: 1.1em;
            color: #555;
            margin: 0;
        }

        #ride-complete-modal .ride-summary h3 {
            font-size: 2.8em;
            color: var(--driver-color);
            margin: 10px 0;
            font-family: 'Montserrat', sans-serif;
        }

        #rate-driver-btn {
            width: 100%;
            margin-top: 15px;
        }

        /* --- END NEW --- */


        /* --- NEW: Gender Button Styles --- */
        .gender-button-group {
            display: flex;
            gap: 10px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
        }

        .gender-btn {
            flex: 1;
            background: #f9f9f9;
            color: #555;
            border: none;
            padding: 12px 15px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .gender-btn:hover {
            background: #f0f0f0;
        }

        .gender-btn.active {
            color: white;
        }

        /* --- NEW: Blinking Animation for Women Shield --- */
        @keyframes blink-animation {
            0% {
                opacity: 1;
                color: var(--accent-color);
            }

            50% {
                opacity: 0.3;
                color: #f39c12;
            }

            100% {
                opacity: 1;
                color: var(--accent-color);
            }
        }

        .nav-links a.women-shield-blinking:not(.disabled) {
            animation: blink-animation 1.5s infinite;
            color: var(--accent-color) !important;
            cursor: pointer;
        }

        /* --- END NEW --- */

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* * ===========================================
         * HERE IS THE BACKGROUND IMAGE FIX
         * ===========================================
        */
        body {
            font-family: 'Open Sans', sans-serif;

            /* 1. Make sure your image (e.g., 'my-background.jpg') is inside the 'Photoes' folder.
               2. Change 'your-background-image.jpg' below to match your image file name.
            */
            background: linear-gradient(rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.35)),
                url('Photoes/index.jpg') center/cover no-repeat fixed;



            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            /* === NEW STICKY FOOTER STYLES === */
            display: flex;
            flex-direction: column;
        }

        /* =========================================== */


        .sidebar-toggle {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 10px;
            cursor: pointer;
            z-index: 999;
            border-radius: 10px 0 0 10px;
            font-size: 16px;
            font-weight: 600;
            box-shadow: -3px 0 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        .sidebar-toggle i {
            margin-bottom: 8px;
            display: block;
        }

        .sidebar-toggle:hover {
            background: var(--hover-color);
            padding-right: 15px;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            max-width: 90%;
            height: 100vh;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            box-shadow: -5px 0 25px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary-color);
        }

        .sidebar-header h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.3s;
        }

        .sidebar-close:hover {
            color: var(--primary-color);
            transform: rotate(90deg);
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--secondary-color);
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
        }

        .news-item,
        .event-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .news-item:hover,
        .event-item:hover {
            box-shadow: 0 5px 20px rgba(255, 77, 77, 0.3);
            transform: translateX(-5px);
            border-left-color: var(--primary-color);
        }

        .news-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .news-item h4,
        .event-item h4 {
            color: var(--secondary-color);
            font-size: 1em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .news-item p,
        .event-item p {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .news-date,
        .event-date {
            color: var(--primary-color);
            font-size: 0.85em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
        }

        .event-date i {
            color: var(--primary-color);
        }

        .event-item {
            border-left: 4px solid var(--footer-accent);
        }

        .event-item:hover {
            border-left-color: var(--footer-hover);
            box-shadow: 0 5px 20px rgba(255, 204, 0, 0.3);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
        }

        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1em 3em;
            background: rgba(34, 34, 34, 0.85);
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            transition: background 0.3s ease;
        }

        nav:hover {
            background: rgba(34, 34, 34, 0.95);
        }

        .nav-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8em;
            font-weight: bold;
            color: #fff;
            transition: color 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .nav-title:hover {
            color: var(--primary-color);
        }

        #website_logo {
            height: 40px;
            width: auto;
            vertical-align: middle;
            margin-right: 10px;
            transition: transform 0.3s ease;
            background-color: #fff;
            border-radius: 50%;
        }

        .nav-title:hover #website_logo {
            transform: scale(1.1);
        }

        .nav-links {
            display: flex;
            gap: 2em;
            list-style: none;
        }

        .nav-links li {
            position: relative;
        }

        .nav-links a {
            color: #fff;
            text-decoration: none;
            font-size: 1em;
            padding: 0.5em 0;
            font-weight: 600;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3em;
        }

        .nav-links a::after {
            content: '';
            display: block;
            width: 0;
            height: 2px;
            background: var(--primary-color);
            transition: width 0.3s;
            position: absolute;
            bottom: 0;
            left: 0;
        }

        /* --- NEW: Fix for dropdown hover gap --- */
        /* Add extra padding to the bottom of dropdown triggers to bridge the gap */
        .nav-links li.dropdown>a {
            /* This adds 10px of padding to the existing 0.5em to cover the menu's margin-top */
            padding-bottom: calc(0.5em + 10px);
        }

        /* Adjust the underline position to account for the new padding */
        /* This rule must come AFTER the .nav-links a::after rule to override it */
        .nav-links li.dropdown>a::after {
            bottom: 10px;
            /* This moves it up from the bottom of the new padding to sit under the text */
        }

        /* --- END NEW --- */

        /* --- NEW: Disabled Nav Link Style --- */
        .nav-links a.disabled {
            color: #888 !important;
            /* Muted color */
            cursor: not-allowed;
        }

        .nav-links a.disabled:hover {
            color: #888 !important;
        }

        .nav-links a.disabled::after {
            display: none !important;
            /* No underline effect */
        }

        /* --- END NEW --- */

        /* --- NEW: Profile Icon & Dropdown Styles --- */
        /* Style for the user "button" */
        #nav-user-info {
            cursor: pointer;
        }

        .nav-user-photo-class {
            height: 40px;
            width: 40px;
            border-radius: 50%;
            background: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: 700;
            border: 2px solid #555;
            transition: all 0.3s ease;
            object-fit: cover;
            /* <-- NEW: For images */
        }

        #nav-user-info:hover .nav-user-photo-class {
            border-color: var(--primary-color);
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.7);
        }

        /* === END NEW === */

        /* --- NEW: Profile Icon Color by Role --- */
        .profile-role-traveler .nav-user-photo-class {
            background: var(--traveler-color);
            border-color: var(--traveler-bg);
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.7);
        }

        .profile-role-traveler:hover .nav-user-photo-class {
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.7);
        }

        .profile-role-driver .nav-user-photo-class {
            background: var(--driver-color);
            border-color: var(--driver-bg);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.7);
        }

        .profile-role-driver:hover .nav-user-photo-class {
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.7);
        }

        .profile-role-emergency .nav-user-photo-class {
            background: var(--emergency-color);
            /* Already red */
            border-color: var(--emergency-bg);
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.7);
        }

        .profile-role-emergency:hover .nav-user-photo-class {
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.7);
        }

        .profile-role-emergency:hover #nav-user-initial {
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.7);
        }

        /* --- END NEW --- */

        .dropdown-menu#profile-dropdown-menu {
            display: none;
            /* Hidden by default */
            position: absolute;
            top: 100%;
            /* Position below the icon */
            right: 0;
            /* Align to the right */
            left: auto;
            background: #fff;
            /* Light background */
            color: var(--secondary-color);
            min-width: 300px;
            /* Wider than other menus */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            padding: 0;
            margin-top: 10px;
            /* Space from icon */
            z-index: 2000;
            border: 1px solid #eee;
            overflow: hidden;
            /* For border-radius on items */

            /* Animation */
            transform-origin: top right;
            transition: all 0.2s ease-out;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }

        .dropdown-menu#profile-dropdown-menu.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* Stop CSS hover from opening this specific menu */
        .nav-links li.dropdown:hover .dropdown-menu#profile-dropdown-menu {
            display: none;
        }

        /* ...but allow it to stay open if active */
        .nav-links li.dropdown:hover .dropdown-menu#profile-dropdown-menu.active {
            display: block;
        }

        #profile-dropdown-menu li {
            width: 100%;
            margin: 0;
            padding: 0;
            list-style: none;
        }

        /* Special Header Item */
        .profile-dropdown-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        .profile-dropdown-header .icon {
            font-size: 1.8em;
            color: var(--primary-color);
            background: #fef0f0;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .profile-dropdown-header .details {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .profile-dropdown-header h4 {
            margin: 0;
            font-size: 1.1em;
            color: #222;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-dropdown-header p {
            margin: 0;
            font-size: 0.9em;
            color: #777;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- NEW: Photo Upload Options --- */
        .profile-photo-options {
            display: flex;
            justify-content: space-around;
            padding: 10px 5px;
            background: #fdfdfd;
            border-bottom: 1px solid #eee;
        }

        .profile-photo-options a {
            flex: 1;
            text-align: center;
            padding: 10px 5px !important;
            font-size: 0.9em !important;
            gap: 8px !important;
            flex-direction: column;
            color: #555 !important;
        }

        .profile-photo-options a i {
            margin: 0 !important;
            width: auto !important;
            font-size: 1.4em !important;
            color: var(--primary-color);
        }

        .profile-photo-options a:hover {
            background: #f5f5f5 !important;
            color: var(--primary-color) !important;
        }

        /* --- END NEW --- */

        /* Standard Menu Items */
        #profile-dropdown-menu li a {
            color: #333;
            /* Dark text for links */
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            padding: 15px 20px;
            font-size: 1em;
            transition: background 0.2s ease, color 0.2s ease;
        }

        #profile-dropdown-menu li a::after {
            display: none;
            /* Remove underline effect */
        }

        #profile-dropdown-menu li a i {
            width: 25px;
            text-align: center;
            color: var(--primary-color);
            font-size: 1.2em;
        }

        #profile-dropdown-menu li a .chevron {
            margin-left: auto;
            color: #aaa;
            font-size: 0.9em;
            transition: color 0.2s ease;
        }

        #profile-dropdown-menu li a:hover {
            background: #f9f9f9;
            color: var(--primary-color);
            /* Hover color */
        }

        #profile-dropdown-menu li a:hover .chevron {
            color: var(--primary-color);
        }

        /* Special item styles */
        .profile-menu-rating {
            background: #fdfaf0;
            /* Light yellow bg */
        }

        .profile-menu-rating a:hover {
            background: #fbf5e6;
        }

        .profile-menu-rating a i.fa-star {
            color: #f39c12;
            /* Star color */
        }

        #profile-dropdown-menu li.logout-item a {
            color: var(--primary-color);
            /* Red for logout */
        }

        #profile-dropdown-menu li.logout-item a:hover {
            background: #fef0f0;
        }

        /* --- END NEW Profile Dropdown Styles --- */


        /* --- NEW: Desktop Dropdown Styles --- */
        /* Make sure parent is relative */
        .nav-links li.dropdown {
            position: relative;
        }

        /* Style for the dropdown menu itself */
        .nav-links li.dropdown .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #fff;
            /* Light background for submenus */
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            min-width: 280px;
            /* Wider for content */
            margin-top: 10px;
            /* Add some space */
            z-index: 2000;
            overflow: hidden;
            /* For border-radius */

            /* Animation */
            transform-origin: top left;
            transition: all 0.2s ease-out;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }

        /* --- MODIFICATION: Show on .active class, NOT on hover --- */
        /* Show on hover - REMOVED
        .nav-links li.dropdown:hover .dropdown-menu {
            display: block;
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        */

        /* NEW: Show when parent LI has .active class */
        .nav-links li.dropdown.active>.dropdown-menu {
            display: block;
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* --- END MODIFICATION --- */


        /* Submenu item styling */
        .nav-links li.dropdown .dropdown-menu li {
            width: 100%;
            margin: 0;
            /* Reset */
            padding: 0;
            /* Reset */
            list-style: none;
            /* Reset */
        }

        .nav-links li.dropdown .dropdown-menu li a {
            color: var(--secondary-color);
            /* Dark text on light bg */
            padding: 14px 20px;
            /* Good padding */
            width: 100%;
            display: block;
            /* Make it full width */
            font-weight: 600;
            /* Match parent */
            gap: 10px;
            /* Space for icons */
        }

        .nav-links li.dropdown .dropdown-menu li a::after {
            /* Remove the main nav underline effect */
            display: none;
        }

        .nav-links li.dropdown .dropdown-menu li a:hover {
            background: #f5f5f5;
            color: var(--primary-color);
        }

        /* This rule (which you already have) is crucial: */
        /* It stops this CSS hover from opening the JS-controlled profile menu */
        /* --- MODIFICATION: This rule is no longer needed as hover is disabled --- */
        /*
        .nav-links li.dropdown:hover .dropdown-menu#profile-dropdown-menu {
            display: none !important;
        }
        */
        /* --- END MODIFICATION --- */


        /* ...but allows it to stay open if JS added .active */
        /* --- MODIFICATION: This rule is now covered by the main .active rule, but let's keep it for specificity --- */
        .nav-links li.dropdown.active>.dropdown-menu#profile-dropdown-menu.active {
            display: block !important;
            /* Keep !important just in case */
        }

        /* --- END NEW Desktop Dropdown Styles --- */


        /* --- NEW: Generic Profile Modal Styles --- */
        .profile-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 9998;
            /* Below reg-modal (9999) but above rest */
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .profile-modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .profile-modal-content {
            background: #fff;
            color: var(--secondary-color);
            border-radius: 12px;
            padding: 30px 40px;
            max-width: 500px;
            width: 100%;
            position: relative;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            transition: transform 0.3s ease;
            max-height: 90vh;
            /* <-- NEW */
            overflow-y: auto;
            /* <-- NEW */
        }

        .profile-modal-overlay.active .profile-modal-content {
            transform: scale(1);
        }

        .profile-modal-content h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Make sure modal h2 styles don't conflict */
        .profile-modal-content h2 {
            color: var(--primary-color) !important;
            border-bottom: 2px solid #eee !important;
        }

        /* --- NEW: Modal Role-Specific Header Colors --- */
        #book-ride-modal .profile-modal-content h2,
        #bidding-modal .profile-modal-content h2,
        #tracking-modal .profile-modal-content h2,
        #ride-complete-modal .profile-modal-content h2 {
            color: var(--traveler-color) !important;
            border-bottom-color: var(--traveler-color) !important;
        }

        #ride-requests-modal .profile-modal-content h2,
        #make-offer-modal .profile-modal-content h2,
        #new-pickup-modal .profile-modal-content h2 {
            color: var(--driver-color) !important;
            border-bottom-color: var(--driver-color) !important;
        }

        #active-alerts-modal .profile-modal-content h2,
        #priority-route-modal .profile-modal-content h2 {
            color: var(--emergency-color) !important;
            border-bottom-color: var(--emergency-color) !important;
        }

        /* --- END NEW --- */


        .profile-modal-content p {
            font-size: 1em;
            color: #555;
            line-height: 1.6;
        }

        .profile-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
        }

        .profile-modal-close:hover {
            color: var(--primary-color);
        }

        /* --- END NEW Profile Modal Styles --- */

        /* --- NEW: Styles for Rating Modal --- */
        .star-rating-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            font-size: 2.5em;
            /* Bigger stars */
            color: #ccc;
            margin: 20px 0 25px;
            cursor: pointer;
        }

        .star-rating-container .star {
            transition: color 0.2s, transform 0.2s;
        }

        /* Hover effect: all stars up to and including the hovered one */
        .star-rating-container:hover .star {
            color: var(--accent-color);
        }

        .star-rating-container .star:hover~.star {
            color: #ccc;
        }

        /* Selected stars (after click) */
        .star-rating-container .star.selected {
            color: var(--accent-color);
            transform: scale(1.1);
        }

        /* Keep hover effect working */
        .star-rating-container:hover .star.selected {
            color: var(--accent-color);
        }

        .star-rating-container .star.selected:hover~.star {
            color: #ccc;
        }

        .star-rating-container .star.selected~.star {
            color: #ccc;
        }


        .review-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Open Sans', sans-serif;
            resize: vertical;
            margin-bottom: 20px;
        }

        .review-textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(255, 77, 77, 0.3);
        }

        .submit-review-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-review-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .submit-review-btn:hover:not(:disabled) {
            background: var(--hover-color);
        }

        #rating-modal .success-message {
            /* display: none; */
            /* Handled inline */
            padding: 20px 0;
            text-align: center;
        }

        #rating-modal .success-message i {
            font-size: 3em;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        #rating-modal .success-message h3 {
            color: var(--secondary-color);
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        #rating-modal .success-message p {
            color: #666;
            font-size: 1em;
        }

        /* --- END Rating Modal Styles --- */

        /* --- NEW: Styles for FAQ in Help Modal --- */
        .faq-accordion {
            margin-top: 25px;
        }

        .faq-item {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
            /* To contain details */
        }

        .faq-title {
            padding: 15px 20px;
            font-weight: 600;
            color: var(--secondary-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }

        .faq-title:hover {
            background: #f1f1f1;
        }

        .faq-chevron {
            font-size: 0.9em;
            color: #aaa;
            transition: transform 0.3s ease, color 0.3s ease;
        }

        .faq-item.active .faq-title {
            color: var(--primary-color);
        }

        .faq-item.active .faq-chevron {
            transform: rotate(90deg);
            color: var(--primary-color);
        }

        .faq-details {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out, padding 0.4s ease-out;
            padding: 0 20px;
            color: #555;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .faq-details.open {
            opacity: 1;
            padding: 0 20px 20px;
            /* Add bottom padding when open */
        }

        .faq-details p {
            margin: 0;
        }

        .faq-details a {
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: none;
        }

        .faq-details a:hover {
            text-decoration: underline;
        }

        /* --- END FAQ Styles --- */

        /* --- NEW: Styles for Wallet Modal --- */
        #payment-modal .wallet-balance {
            background: linear-gradient(135deg, var(--secondary-color), #444);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        #payment-modal .wallet-balance p {
            font-size: 1.1em;
            color: #eee;
            margin: 0;
        }

        #payment-modal .wallet-balance h3 {
            font-size: 3em;
            color: white;
            margin: 5px 0 15px;
            font-family: 'Montserrat', sans-serif;
        }

        .add-money-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .add-money-btn:hover {
            background: var(--hover-color);
        }

        #add-money-section {
            display: none;
            /* Hidden by default */
            padding: 20px;
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-top: 20px;
        }

        /* Use existing form styles */
        #add-money-section .form-group {
            margin-bottom: 20px;
        }

        #add-money-section .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        #add-money-section .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        #add-money-section .form-group input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(255, 77, 77, 0.3);
        }

        /* --- */

        #payment-modal h4 {
            font-family: 'Montserrat', sans-serif;
            color: var(--secondary-color);
            font-size: 1.2em;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .saved-payment-method {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .saved-payment-method .icon {
            font-size: 2.2em;
            color: #007bff;
            /* Visa blue */
        }

        .saved-payment-method .details {
            flex-grow: 1;
        }

        .saved-payment-method .details p {
            font-size: 1em;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .saved-payment-method .details span {
            font-size: 0.9em;
            color: #777;
        }

        .saved-payment-method .remove-btn {
            font-size: 0.9em;
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
            background: none;
            border: none;
        }

        .saved-payment-method .remove-btn:hover {
            text-decoration: underline;
        }

        /* --- END Wallet Styles --- */

        /* --- NEW: Styles for My Rides Modal --- */
        .ride-history-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .ride-history-list li {
            padding: 10px 5px;
        }

        .ride-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }

        .ride-item .icon {
            font-size: 1.8em;
            color: var(--primary-color);
        }

        .ride-item .ride-details {
            flex-grow: 1;
        }

        .ride-item .ride-details p {
            font-size: 1em;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .ride-item .ride-details span {
            font-size: 0.9em;
            color: #777;
            display: block;
        }

        .ride-item .ride-price {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--secondary-color);
        }

        /* --- NEW: Styles for Ride Requests & Alerts Modals --- */
        .modal-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 350px;
            overflow-y: auto;
        }

        .modal-list-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }

        .modal-list-item .icon {
            font-size: 1.8em;
            flex-shrink: 0;
        }

        .modal-list-item .details {
            flex-grow: 1;
        }

        .modal-list-item .details p {
            font-size: 1em;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .modal-list-item .details span {
            font-size: 0.9em;
            color: #777;
            display: block;
            line-height: 1.4;
        }

        /* Ride Request Item */
        .ride-request-item .icon {
            color: var(--traveler-color);
        }

        /* --- MODIFIED: Renamed to make-offer-btn --- */
        .ride-request-item .make-offer-btn {
            background: var(--driver-color);
            color: white;
            border: none;
            padding: 8px 12px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
            align-self: center;
        }

        .ride-request-item .make-offer-btn:hover {
            background: var(--driver-hover);
        }

        /* Alert Item */
        .alert-item .icon {
            color: var(--emergency-color);
        }

        .alert-item .details span {
            font-weight: 600;
            color: #555;
        }

        .alert-item .details .timestamp {
            font-size: 0.8em;
            font-weight: normal;
            color: #888;
        }

        /* --- END NEW --- */


        /* --- NEW: Styles for Safety Modal --- */
        .safety-features {
            display: flex;
            gap: 15px;
            margin: 25px 0;
        }

        .safety-feature-btn {
            flex: 1;
            padding: 20px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .safety-feature-btn i {
            font-size: 1.8em;
        }

        .safety-feature-btn.share-btn {
            background: #007bff;
            color: white;
        }

        .safety-feature-btn.share-btn:hover {
            background: #0056b3;
            transform: translateY(-3px);
        }

        .safety-feature-btn.sos-btn {
            background: var(--primary-color);
            color: white;
        }

        .safety-feature-btn.sos-btn:hover {
            background: var(--hover-color);
            transform: translateY(-3px);
        }

        .safety-tips-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        .safety-tips-list li {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
        }

        .safety-tips-list li i {
            color: #4CAF50;
            font-size: 1.2em;
        }

        /* --- END Safety & Rides Styles --- */

        /* --- NEW: Styles for Refer & Rewards Modals --- */
        #refer-modal .referral-code-box {
            display: flex;
            margin: 25px 0;
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            overflow: hidden;
        }

        #referral-code {
            flex-grow: 1;
            padding: 15px;
            font-size: 1.4em;
            font-weight: 700;
            color: var(--secondary-color);
            border: none;
            background: #fdf0f0;
            font-family: 'Montserrat', sans-serif;
            text-align: center;
        }

        #referral-code:focus {
            outline: none;
        }

        #referral-copy-btn {
            padding: 0 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s;
        }

        #referral-copy-btn:hover {
            background: var(--hover-color);
        }

        #referral-copy-btn:active {
            transform: scale(0.95);
        }

        #refer-modal .social-share-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .social-share-btn {
            font-size: 1.8em;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .social-share-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .social-share-btn.whatsapp {
            background: #25D366;
        }

        .social-share-btn.twitter {
            background: #1DA1F2;
        }

        .social-share-btn.facebook {
            background: #1877F2;
        }

        .social-share-btn.sms {
            background: #777;
        }

        .rewards-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .rewards-list li {
            padding: 5px 0;
        }

        .reward-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-left: 5px solid var(--accent-color);
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        }

        .reward-item .icon {
            font-size: 2.5em;
            color: var(--accent-color);
        }

        .reward-item .details {
            flex-grow: 1;
        }

        .reward-item .details h4 {
            font-size: 1.1em;
            color: var(--secondary-color);
            margin: 0 0 5px;
            padding: 0;
            border: none;
        }

        .reward-item .details p {
            font-size: 0.9em;
            color: #666;
            margin: 0;
        }

        .reward-item .claim-btn {
            background: var(--accent-color);
            color: var(--secondary-color);
            border: none;
            padding: 8px 15px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .reward-item .claim-btn:hover {
            background: var(--accent-hover);
        }

        .reward-item .claim-btn[disabled] {
            background: #ccc;
            cursor: not-allowed;
        }

        /* --- END Refer & Rewards Styles --- */


        header {
            margin-top: 70px;
            background: rgba(255, 77, 77, 0.9);
            color: var(--card-bg);
            padding: 2em 1em 2.5em;
            text-align: center;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        header main h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: clamp(2em, 4vw, 2.6em);
            margin-bottom: 0.5em;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.5);
        }

        header main p {
            font-size: 1.1em;
            color: #f0f0f0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            margin-bottom: 1em;
        }

        header main figure {
            margin: 0;
            padding: 0;
        }

        header main figure blockquote {
            font-style: italic;
            font-size: 1.1em;
            margin: 1em auto 0;
            color: #ffffff;
            max-width: 600px;
            padding: 0.8em 1em;
            border-left: 5px solid rgb(255, 255, 255);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
        }

        .content {
            max-width: 1000px;
            margin: 2.5em auto;
            padding: 2em 1.5em;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .content h2#why-ai-traffic-lights {
            font-size: 2em;
            text-align: center;
            padding-bottom: 0.5em;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 1.5em;
        }

        .flex-cards {
            display: flex;
            gap: 2em;
            flex-wrap: wrap;
            margin-bottom: 2.5em;
        }

        .flex-cards>article {
            flex: 1;
            min-width: 300px;
        }

        .education,
        .tips {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2em;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: box-shadow var(--transition-speed);
        }

        .education:hover,
        .tips:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        h2:not(#why-ai-traffic-lights) {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            margin-bottom: 1.5em;
        }

        .tip,
        .edu-item {
            margin-bottom: 15px;
            padding: 1.2em 1.5em;
            background: var(--light-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            border: 1px solid transparent;
        }

        .tip.active,
        .edu-item.active {
            background: #ffffff;
            border-color: var(--primary-color);
        }

        .tip-title,
        .edu-title {
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }

        .tip-title i,
        .edu-title i {
            margin-right: 10px;
            color: var(--primary-color);
            flex-shrink: 0;
        }

        .tip-chevron,
        .edu-chevron {
            flex-shrink: 0;
            transition: transform var(--transition-speed) ease, color var(--transition-speed);
            color: #aaa;
        }

        .tip.active .tip-chevron,
        .edu-item.active .edu-chevron {
            transform: rotate(90deg);
            color: var(--primary-color);
        }

        .tip-details,
        .edu-details {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.6s ease-in-out, opacity 0.4s ease-in-out 0.2s, padding 0.5s ease;
            padding: 0 1.5em;
            color: #555;
            font-weight: normal;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .tip-details.open,
        .edu-details.open {
            opacity: 1;
            padding: 0 1.5em 1.5em;
        }

        .community-box {
            margin: 3em 0;
            padding: 2.5em;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            text-align: center;
            border: 2px solid var(--footer-accent);
        }

        .community-box h2 {
            color: var(--secondary-color);
            font-size: 2em;
            margin-bottom: 0.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .community-box h2 i {
            color: var(--footer-accent);
        }

        .community-box>p {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 2em;
            line-height: 1.7;
        }

        /* === NEW: Style for the logged-out prompt === */
        #community-login-prompt {
            text-align: center;
        }

        #community-login-prompt p {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 1.5em;
        }

        .community-login-btns {
            display: flex;
            justify-content: center;
            gap: 1em;
            flex-wrap: wrap;
        }

        .community-login-btns .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: white;
        }

        .community-login-btns .btn-primary {
            background: var(--primary-color);
        }

        .community-login-btns .btn-primary:hover {
            background: var(--hover-color);
            transform: scale(1.05);
        }

        .community-login-btns .btn-secondary {
            background: #007bff;
        }

        .community-login-btns .btn-secondary:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        /* === END NEW === */


        .registration-options {
            display: flex;
            gap: 1.5em;
            /* Reduced from 2em */
            justify-content: center;
            flex-wrap: wrap;
        }

        .reg-card {
            flex: 1;
            min-width: 260px;
            /* Reduced from 280px */
            max-width: 400px;
            background: white;
            padding: 2em;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .reg-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-color);
        }

        .reg-card.driver:hover {
            border-color: var(--driver-color);
        }

        .reg-card.emergency:hover {
            border-color: var(--emergency-color);
        }

        .reg-card-icon {
            font-size: 4em;
            margin-bottom: 0.5em;
        }

        .reg-card.driver .reg-card-icon {
            color: var(--driver-color);
        }

        .reg-card.emergency .reg-card-icon {
            color: var(--emergency-color);
        }

        .reg-card h3 {
            font-size: 1.5em;
            margin-bottom: 0.5em;
            color: var(--secondary-color);
        }

        .reg-card p {
            color: #666;
            margin-bottom: 1.5em;
            font-size: 0.95em;
        }

        .reg-btn {
            padding: 12px 30px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reg-btn:hover {
            background: var(--hover-color);
            transform: scale(1.05);
        }

        .reg-card.driver .reg-btn {
            background: var(--driver-color);
        }

        .reg-card.driver .reg-btn:hover {
            background: var(--driver-hover);
        }

        /* === NEW TRAVELER CARD STYLES === */
        .reg-card.traveler:hover {
            border-color: var(--traveler-color);
            /* Blue */
        }

        .reg-card.traveler .reg-card-icon {
            color: var(--traveler-color);
        }

        .reg-card.traveler .reg-btn {
            background: var(--traveler-color);
        }

        .reg-card.traveler .reg-btn:hover {
            background: var(--traveler-hover);
        }

        /* === END TRAVELER CARD STYLES === */

        .reg-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
        }

        .reg-modal-overlay.active {
            display: flex;
        }

        .reg-form-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        /* === NEW: Password Instructions Styles === */
        .password-instructions {
            display: block;
            /* MODIFIED: Was 'none', now always visible */
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .password-instructions h4 {
            margin: 0 0 10px 0;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .password-instructions ul {
            list-style: none;
            padding-left: 0;
        }

        .password-instructions li {
            color: #666;
            padding-left: 25px;
            position: relative;
            line-height: 1.6;
            transition: color 0.3s ease;
        }

        .password-instructions li::before {
            content: '\f00d';
            /* fas fa-times */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            left: 0;
            top: 2px;
            color: var(--primary-color);
            transition: all 0.3s ease;
        }

        .password-instructions li.valid {
            color: #333;
            text-decoration: line-through;
        }

        .password-instructions li.valid::before {
            content: '\f00c';
            /* fas fa-check */
            color: #4CAF50;
            transform: scale(1.1);
        }

        /* === END NEW === */

        /* === NEW: Hide wrappers by default === */
        #login-form-wrapper,
        #signup-form-wrapper,
        #driver-form-wrapper,
        #emergency-form-wrapper,
        #traveler-form-wrapper,
        #driver-success-message,
        #emergency-success-message,
        #traveler-success-message {
            display: none;
        }

        /* === END NEW === */


        .reg-form-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .reg-form-close:hover {
            color: var(--primary-color);
        }

        .reg-form-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .reg-form-header h2 {
            color: var(--secondary-color);
            font-size: 2em;
            margin-bottom: 10px;
        }

        .reg-form-header p {
            color: #666;
            font-size: 1em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .form-group label i {
            margin-right: 8px;
            color: var(--primary-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: 'Open Sans', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(255, 77, 77, 0.3);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .submit-btn:hover:not(:disabled) {
            background: var(--hover-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3);
        }

        .success-message {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .success-message i {
            font-size: 4em;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .success-message h3 {
            color: var(--secondary-color);
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .success-message p {
            color: #666;
            font-size: 1.1em;
        }

        /* Styles for new registration forms */
        #driver-form-wrapper,
        #emergency-form-wrapper,
        #traveler-form-wrapper,
        /* Add traveler wrapper */
        #driver-success-message,
        #emergency-success-message,
        #traveler-success-message {
            /* Add traveler success */
            display: none;
            /* Hidden by default */
        }

        .form-group-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .form-group-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .form-group-checkbox label {
            margin-bottom: 0;
            font-weight: normal;
            color: #555;
        }

        .submit-btn.emergency-btn {
            background: var(--emergency-color);
        }

        .submit-btn.emergency-btn:hover:not(:disabled) {
            background: var(--emergency-hover);
            box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3);
        }

        .submit-btn.driver-btn {
            background: var(--driver-color);
        }

        .submit-btn.driver-btn:hover:not(:disabled) {
            background: var(--driver-hover);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        /* === NEW TRAVELER BUTTON STYLE === */
        .submit-btn.traveler-btn {
            background: var(--traveler-color);
        }

        .submit-btn.traveler-btn:hover:not(:disabled) {
            background: var(--traveler-hover);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        /* === END TRAVELER BUTTON STYLE === */

        /* === NEW MAP STYLES === */
        .map-preview-btn {
            background-color: #6c757d;
            /* A neutral gray */
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1em;
            padding: 12px;
        }

        .map-preview-btn:hover:not(:disabled) {
            background-color: #5a6268;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .map-container {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            background: #f4f4f4;
            border: 2px solid #ddd;
        }

        .map-container iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }

        .map-api-notice {
            color: #b22222;
            /* Firebrick red */
            text-align: center;
            padding: 20px;
            font-weight: 600;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .map-api-notice i {
            font-size: 2em;
            margin-bottom: 10px;
        }

        /* === END NEW MAP STYLES === */

        /* End of new styles */


        .pledge-box {
            margin-top: 3em;
            padding: 2.5em;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 1px solid var(--primary-color);
        }

        .pledge-box h2 {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5em;
            margin-bottom: 0.8em;
            font-size: 2em;
        }

        .pledge-box p {
            margin-bottom: 1.5em;
            color: var(--text-color);
        }

        .pledge-form-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 2em;
        }

        .pledge-form-group label {
            font-weight: 700;
            color: var(--primary-color);
        }

        .pledge-form-group input[type="text"] {
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            flex-grow: 1;
            max-width: 300px;
            transition: border-color 0.3s;
        }

        .pledge-form-group input[type="text"]:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(255, 77, 77, 0.5);
        }

        #generate-pledge-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s;
        }

        #generate-pledge-btn:hover {
            background-color: var(--hover-color);
        }

        #generate-pledge-btn:active {
            transform: scale(0.98);
        }

        .pledge-output {
            margin-top: 1.5em;
            padding: 1.5em;
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            background: #ffecec;
            font-style: italic;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            line-height: 1.6;
        }

        .pledge-output p {
            margin-bottom: 0;
        }

        .pledge-output strong {
            color: var(--secondary-color);
            font-size: 1.1em;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            overflow: auto;
            padding: 20px;
        }

        .certificate-container {
            width: 750px;
            max-width: 95%;
            background: #fff8e7;
            border: 12px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            position: relative;
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.8);
            font-family: 'Montserrat', sans-serif;
            margin: 20px 0;
        }

        .cert-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            color: #d4af37;
            cursor: pointer;
        }

        .certificate-logo {
            height: 80px;
            margin-bottom: 10px;
        }

        .certificate-header h2 {
            color: #b8860b;
            margin-bottom: 5px;
            font-size: 2.2em;
            font-weight: 700;
        }

        .certificate-header p {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 20px;
        }

        .certificate-body {
            margin: 20px 0;
        }

        .certificate-body blockquote {
            font-style: italic;
            margin: 20px auto;
            padding: 15px;
            border-left: 5px solid #d4af37;
            background: #fff3c2;
            border-radius: 5px;
            max-width: 600px;
            color: #555;
            font-size: 1em;
        }

        .cert-name {
            display: block;
            font-size: 1.6em;
            font-weight: 700;
            margin: 10px 0;
            color: #b8860b;
            text-transform: uppercase;
        }

        .certificate-footer {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .signature-img {
            height: 60px;
        }

        .certificate-date p,
        .certificate-signature p {
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .cert-btn {
            background: #d4af37;
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-weight: 700;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            font-size: 1em;
            transition: background-color 0.3s;
        }

        .cert-btn:hover {
            background: #b8860b;
        }

        .cert-btn i {
            margin-right: 8px;
        }

        .cert-btn.fab {
            background-color: #25D366;
        }

        .cert-btn.fab:hover {
            background-color: #128C7E;
        }

        .cert-button-group {
            margin-top: 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        #confetti-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            width: 100%;
            height: 100%;
            z-index: 10000;
        }

        .hero-modal-content {
            background: linear-gradient(135deg, var(--primary-color) 0%, #c0392b 100%);
            color: #fff;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            font-family: 'Montserrat', sans-serif;
            border: 4px solid #fff;
        }

        #hero-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 30px;
            color: #fff;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s, transform 0.3s;
        }

        #hero-close-btn:hover {
            opacity: 1;
            transform: rotate(90deg);
        }

        .hero-modal-content h1 {
            font-size: 2.8em;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .hero-modal-content h2 {
            font-size: 1.5em;
            font-weight: 400;
            opacity: 0.9;
            color: #fff !important;
            border: none !important;
            margin-bottom: 0 !important;
        }

        .hero-modal-content p {
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .hero-modal-content p.emphasis {
            font-weight: 700;
            font-size: 1.2em;
            color: var(--footer-accent);
        }

        /* Simple error message style for forms */
        .form-error {
            color: var(--primary-color);
            background: #ffecec;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            display: none;
            /* Hidden by default */
            text-align: center;
            font-weight: 600;
        }

        /* --- NEW: Form Error for Modals --- */
        .modal-form-error {
            color: var(--primary-color);
            background: #ffecec;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            display: none;
            /* Hidden by default */
            text-align: center;
            font-weight: 600;
        }

        /* --- END NEW --- */

        /* === NEW: Circular Photo Uploader === */
        .profile-photo-uploader {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 25px;
            /* Center it */
            cursor: pointer;
            border-radius: 50%;
            background: #f0f0f0;
            border: 3px dashed #ccc;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            /* To keep image circular */
        }

        .profile-photo-uploader:hover {
            border-color: var(--primary-color);
            background: #e9e9e9;
        }

        .profile-photo-uploader .upload-icon {
            font-size: 3em;
            color: #aaa;
            transition: all 0.3s ease;
        }

        .profile-photo-uploader:hover .upload-icon {
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .profile-photo-uploader .photo-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* This is key */
            border-radius: 50%;
            display: none;
            /* Hide by default */
        }

        .profile-photo-uploader .photo-preview.active {
            display: block;
        }

        .profile-photo-uploader .upload-icon.hidden {
            display: none;
        }

        /* === END NEW === */

        /* === NEW: File Input Styles === */
        .form-group-file label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .form-group-file input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95em;
            background: #f9f9f9;
        }

        .form-group-file input[type="file"]::file-selector-button {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.3s;
        }

        .form-group-file input[type="file"]::file-selector-button:hover {
            background: #555;
        }

        /* === END NEW === */

        /* === NEW PROFILE VIEW STYLES === */
        #community-profile-view {
            border: 4px solid var(--border-color);
            border-radius: 12px;
            padding: 2em;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }

        /* Driver Profile = Green */
        .profile-view-driver {
            border-color: var(--driver-color) !important;
            background: var(--driver-bg) !important;
        }

        .profile-view-driver h2 i {
            color: var(--driver-color);
        }

        .profile-view-driver #community-profile-name {
            color: var(--driver-color);
        }

        /* Traveler Profile = Blue */
        .profile-view-traveler {
            border-color: var(--traveler-color) !important;
            background: var(--traveler-bg) !important;
        }

        .profile-view-traveler h2 i {
            color: var(--traveler-color);
        }

        .profile-view-traveler #community-profile-name {
            color: var(--traveler-color);
        }

        /* Emergency Profile = Red */
        .profile-view-emergency {
            border-color: var(--emergency-color) !important;
            background: var(--emergency-bg) !important;
        }

        .profile-view-emergency h2 i {
            color: var(--emergency-color);
        }

        .profile-view-emergency #community-profile-name {
            color: var(--emergency-color);
        }

        /* Default/Unknown/Guest */
        .profile-view-unknown h2 i,
        .profile-view-guest h2 i {
            color: var(--secondary-color);
        }

        .profile-view-unknown #community-profile-name,
        .profile-view-guest #community-profile-name {
            color: var(--secondary-color);
        }

        /* --- NEW: Role Action Buttons --- */
        .profile-action-buttons {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px dashed #ccc;
        }

        .profile-view-traveler .profile-action-buttons {
            border-top-color: var(--traveler-color);
        }

        .profile-view-driver .profile-action-buttons {
            border-top-color: var(--driver-color);
        }

        .profile-view-emergency .profile-action-buttons {
            border-top-color: var(--emergency-color);
        }

        .role-actions {
            display: flex;
            /* Will be set to 'flex' by JS */
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .profile-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .profile-btn i {
            font-size: 1.1em;
        }

        .profile-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .profile-btn-traveler {
            background-color: var(--traveler-color);
        }

        .profile-btn-traveler:hover {
            background-color: var(--traveler-hover);
        }

        .profile-btn-driver {
            background-color: var(--driver-color);
        }

        .profile-btn-driver:hover {
            background-color: var(--driver-hover);
        }

        .profile-btn-emergency {
            background-color: var(--emergency-color);
        }

        .profile-btn-emergency:hover {
            background-color: var(--emergency-hover);
        }

        /* --- NEW: On Duty Toggle --- */
        .on-duty-toggle-container {
            display: flex;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        #on-duty-status-text {
            font-size: 1.1em;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        #on-duty-status-text.on-duty {
            color: var(--driver-color);
        }

        #on-duty-status-text.off-duty {
            color: #777;
        }

        .profile-view-emergency #on-duty-status-text.on-duty {
            color: var(--emergency-color);
        }

        .duty-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .duty-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .duty-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .duty-toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.duty-toggle-slider {
            background-color: var(--driver-color);
        }

        .profile-view-emergency input:checked+.duty-toggle-slider {
            background-color: var(--emergency-color);
        }

        input:checked+.duty-toggle-slider:before {
            transform: translateX(26px);
        }

        /* --- END NEW --- */

        /* === END NEW PROFILE STYLES === */

        /* === NEW STICKY FOOTER STYLES === */
        #main-footer {
            background-color: var(--dark-bg);
            color: var(--light-text);
            padding: 50px 0;
            font-family: 'Poppins', sans-serif;
            margin-top: auto;
            /* This pushes it to the bottom */
        }

        /* --- NEW: Mobile Menu Styles --- */
        .mobile-menu-toggle {
            display: none;
            /* Hidden on desktop */
            background: none;
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            z-index: 2001;
            /* Above nav links */
        }

        @media (max-width: 992px) {
            nav {
                padding: 1em 1.5em;
                /* Adjust padding for mobile */
            }

            .nav-title {
                font-size: 1.5em;
                /* Smaller title */
            }

            .mobile-menu-toggle {
                display: block;
                /* Show hamburger button */
            }

            #nav-menu-container {
                display: none;
                /* Hide menu container by default */
                position: absolute;
                top: 100%;
                /* Position below nav */
                left: 0;
                width: 100%;
                background: var(--secondary-color);
                /* Dark bg for mobile menu */
                padding: 1em;
                box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
                max-height: calc(100vh - 70px);
                /* Full height minus nav */
                overflow-y: auto;
                z-index: 2000;

                /* Animation */
                animation: slideDown 0.3s ease-out;
            }

            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            #nav-menu-container.active {
                display: block;
                /* Show when active */
            }

            .nav-links {
                flex-direction: column;
                /* Stack links vertically */
                gap: 0;
                /* Remove desktop gap */
            }

            .nav-links li {
                width: 100%;
            }

            .nav-links a {
                padding: 1em;
                /* Full-width touch targets */
                border-bottom: 1px solid #444;
                /* Separator */
            }

            .nav-links a::after {
                display: none;
                /* No underlines on mobile */
            }

            .nav-links a:hover {
                background: #333;
                color: var(--primary-color);
            }

            /* Mobile Dropdowns */
            /* --- NEW: Add caret rotation on mobile --- */
            .nav-links li.dropdown>a .fa-caret-down {
                transition: transform 0.3s ease;
            }

            .nav-links li.dropdown.active>a .fa-caret-down {
                transform: rotate(180deg);
            }

            /* --- END NEW --- */

            .nav-links li.dropdown .dropdown-menu {
                display: none;
                /* Start hidden */
                position: static;
                /* Not absolute */
                width: 100%;
                background: #1a1a1a;
                /* Even darker */
                box-shadow: none;
                border-radius: 0;
                margin-top: 0;
                padding-left: 1em;
                /* Indent submenu */
                opacity: 1;
                /* Reset for mobile */
                transform: none;
                /* Reset for mobile */
                pointer-events: auto;
                /* Reset for mobile */
                max-height: 0;
                /* Use max-height for animation */
                overflow: hidden;
                transition: max-height 0.3s ease-out;
            }

            .nav-links li.dropdown.active .dropdown-menu {
                display: block;
                /* Show when parent is active */
                max-height: 500px;
                /* Animate open */
            }

            .nav-links li.dropdown .dropdown-menu li a {
                color: #ddd;
                padding: 0.8em 1em;
                border-bottom: 1px solid #333;
            }

            .nav-links li.dropdown .dropdown-menu li a:hover {
                color: var(--primary-color);
            }

            /* Mobile Auth Links */
            #nav-auth-links {
                flex-direction: column;
                padding: 1em;
                gap: 1em;
                border-top: 1px solid #444;
            }

            /* Mobile Profile Dropdown */
            #nav-user-info {
                padding: 1em;
                border-top: 1px solid #444;
                justify-content: space-between;
            }

            .nav-links li.dropdown:hover .dropdown-menu {
                display: none;
                /* Disable hover on mobile */
            }

            .nav-links li.dropdown.active .dropdown-menu {
                display: block;
                /* Show on click */
            }
        }

        /* --- END NEW Mobile Menu Styles --- */


        @media print {
            body>*:not(#certificate-modal) {
                display: none;
            }

            #certificate-modal {
                display: flex !important;
                background: none !important;
                position: absolute !important;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                padding: 0 !important;
                margin: 0 !important;
                overflow: hidden !important;
            }

            .certificate-container {
                box-shadow: none !important;
                border: 10px solid #d4af37 !important;
                margin: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                height: 100% !important;
                page-break-inside: avoid;
                border-radius: 0 !important;
            }

            .cert-close-btn,
            .cert-button-group {
                display: none !important;
            }

            #confetti-canvas {
                display: none !important;
            }
        }
    </style>
</head>

<body>

    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-newspaper"></i> NEWS & EVENTS
    </button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-newspaper"></i> Latest Updates</h2>
            <button class="sidebar-close" id="sidebarClose">&times;</button>
        </div>
        <div class="sidebar-section">
            <h3><i class="fas fa-newspaper"></i> News & Updates</h3>
            <div class="news-item">
                <img src="Photoes/report 1.png" alt="Road safety news"
                    onerror="this.src='https://placehold.co/360x180/eee/999?text=News+Image'; this.onerror=null;">
                <h4>Road Accident Deaths Rise by 12%</h4>
                <p>Latest government reports show a concerning increase in road fatalities across major highways.</p>
                <div class="news-date">
                    <i class="fas fa-calendar"></i> Oct 22, 2025
                </div>
            </div>
            <div class="news-item">
                <img src="Photoes/report3.png" alt="Traffic rules update"
                    onerror="this.src='https://placehold.co/360x180/eee/999?text=News+Image'; this.onerror=null;">
                <h4>New Helmet Law Enforcement</h4>
                <p>Stricter penalties announced for riding without helmets. Fine increased to ₹5,000 for repeat
                    offenders.</p>
                <div class="news-date">
                    <i class="fas fa-calendar"></i> Oct 18, 2025
                </div>
            </div>
            <div class="news-item">
                <img src="Photoes/report 4.jpg" alt="Safety campaign"
                    onerror="this.src='https://placehold.co/360x180/eee/999?text=News+Image'; this.onerror=null;">
                <h4>National Road Safety Week Announced</h4>
                <p>Government launches awareness campaign with focus on drunk driving prevention and seatbelt usage.</p>
                <div class="news-date">
                    <i class="fas fa-calendar"></i> Oct 15, 2025
                </div>
            </div>
            <div class="news-item">
                <img src="Photoes/report 2 .png" alt="Technology news"
                    onerror="this.src='https://placehold.co/360x180/eee/999?text=News+Image'; this.onerror=null;">
                <h4>AI Traffic Signals Reduce Congestion by 30%</h4>
                <p>Pilot project in Delhi shows promising results with intelligent traffic management systems.</p>
                <div class="news-date">
                    <i class="fas fa-calendar"></i> Oct 10, 2025
                </div>
            </div>
        </div>
        <div class="sidebar-section">
            <h3><i class="fas fa-calendar-alt"></i> Upcoming Events</h3>
            <div class="event-item">
                <h4>🎓 Road Safety Workshop</h4>
                <p>Free workshop for drivers on defensive driving techniques and road safety awareness.</p>
                <div class="event-date">
                    <i class="fas fa-map-marker-alt"></i> Mph
                </div>
                <div class="event-date">
                    <i class="fas fa-clock"></i> Nov 5, 2025 - 10:00 AM
                </div>
            </div>
            <div class="event-item">
                <h4>🚦 Traffic Rules Seminar</h4>
                <p>Interactive session covering updated traffic laws and regulations with traffic police officials.</p>
                <div class="event-date">
                    <i class="fas fa-map-marker-alt"></i> Amphitheater
                </div>
                <div class="event-date">
                    <i class="fas fa-clock"></i> Nov 12, 2025 - 3:00 PM
                </div>
            </div>
            <div class="event-item">
                <h4>🏃 Road Safety Marathon</h4>
                <p>Join the city-wide marathon to promote awareness about pedestrian safety and responsible driving.</p>
                <div class="event-date">
                    <i class="fas fa-map-marker-alt"></i>cricket ground
                </div>
                <div class="event-date">
                    <i class="fas fa-clock"></i> Nov 20, 2025 - 6:00 AM
                </div>
            </div>
            <div class="event-item">
                <h4>👨‍👩‍👧‍👦 Family Safety Day</h4>
                <p>Fun-filled day with safety demonstrations, first-aid training, and activities for children.</p>
                <div class="event-date">
                    <i class="fas fa-map-marker-alt"></i> Seminar Hall
                </div>
                <div class="event-date">
                    <i class="fas fa-clock"></i> Nov 25, 2025 - 9:00 AM
                </div>
            </div>
        </div>
    </aside>

    <nav aria-label="Main Navigation">
        <a href="#home" class="nav-title" aria-label="Home">
            <img id="website_logo" src="Photoes/logo.png" alt="SafeReturn Logo"
                onerror="this.src='https://placehold.co/40x40/ffffff/E63939?text=SR'; this.onerror=null;">
            SafeReturn
        </a>

        <!-- === NEW: Menu Wrapper === -->
        <div id="nav-menu-container">
            <ul class="nav-links">
                <li><a href="#home">Home</a></li>
                <li class="dropdown">
                    <a href="#road-safety" aria-expanded="false" aria-haspopup="true">Road Safety Tips <i
                            class="fas fa-caret-down"></i></a>
                    <ul class="dropdown-menu">
                        <li><a href="Road Safety.html">Fundamentals</a></li>
                        <li><a href="vehicles Mechanics.html">Vehicles Mechanics</a></li>
                        <li><a href="Essential Road Safety Instructions.html">Essential Road Safety Instructions</a>
                        </li>
                    </ul>
                </li>
                <li><a href="Quiz.html">Quiz</a></li>
                <!-- === NEW: Women Shield Link === -->
                <li><a href="Women Shield.html" id="nav-women-shield-link" style="color: var(--accent-color);"><i
                            class="fas fa-shield-alt"></i> Women Shield</a></li>
                <!-- === END NEW === -->
                <li class="dropdown">
                    <a href="#why-AI-traffic-lights" aria-expanded="false" aria-haspopup="true">Why AI Traffic Lights <i
                            class="fas fa-caret-down"></i></a>
                    <ul class="dropdown-menu">
                        <li><a href="AI based traffic lights image.html">AI Based traffic lights</a></li>
                        <li><a href="#how-it-works">How it Works</a></li>
                        <li><a href="#benefits">Benefits</a></li>
                        <li><a href="#challenges">Challenges</a></li>
                    </ul>
                </li>
                <li><a href="Collage.html">Collage</a></li>
                <li><a href="footer.html">Contact</a></li>

                <!-- === NEW AUTH LINKS === -->
                <!-- These show when logged OUT -->
                <span id="nav-auth-links" style="display: flex; gap: 1.5em; align-items: center;">
                    <li><a href="#" id="nav-login-btn">Login</a></li>
                    <li><a href="#" id="nav-signup-btn">Sign Up</a></li>
                </span>

                <!-- This shows when logged IN -->
                <li id="nav-user-info" class="dropdown" style="display: none; align-items: center; gap: 15px;">
                    <!-- NEW: Profile Photo Circle -->
                    <img id="nav-user-photo" src="https://placehold.co/40x40/ccc/eee?text=G" alt="Profile"
                        class="nav-user-photo-class">
                    <!-- <a href="#" id="nav-logout-btn" style="color: #fff; background: var(--primary-color); padding: 5px 10px; border-radius: 5px;">Logout</a> -->
                    <!-- OLD LOGOUT BTN - REMOVED -->

                    <!-- === NEW PROFILE DROPDOWN MENU === -->
                    <ul class="dropdown-menu" id="profile-dropdown-menu">
                        <li class="profile-dropdown-header">
                            <div class="icon"><i class="fas fa-user"></i></div>
                            <div class="details">
                                <h4 id="profile-dropdown-name">Guest</h4>
                                <p id="profile-dropdown-contact">Please log in</p>
                            </div>
                        </li>
                        <!-- NEW PHOTO UPLOAD OPTIONS -->
                        <li class="profile-photo-options">
                            <a href="#" id="photo-gallery-btn">
                                <i class="fas fa-images"></i>
                                <span>Add from Gallery</span>
                            </a>
                            <a href="#" id="photo-camera-btn">
                                <i class="fas fa-camera"></i>
                                <span>Click a Photo</span>
                            </a>
                        </li>
                        <!-- END NEW PHOTO UPLOAD OPTIONS -->
                        <li class="profile-menu-rating">
                            <a href="#" data-modal-target="rating-modal">
                                <i class="fas fa-star"></i>
                                <span>My Rating</span>
                                <i class="fas fa-chevron-right chevron"></i>
                            </a>
                        </li>
                        <li><a href="#" data-modal-target="help-modal"><i
                                    class="fas fa-question-circle"></i><span>Help</span><i
                                    class="fas fa-chevron-right chevron"></i></a></li>
                        <li><a href="#" data-modal-target="payment-modal"><i
                                    class="fas fa-credit-card"></i><span>Wallet</span><i
                                    class="fas fa-chevron-right chevron"></i></a></li>
                        <li><a href="#" data-modal-target="rides-modal"><i class="fas fa-route"></i><span>My
                                    Rides</span><i class="fas fa-chevron-right chevron"></i></a></li>
                        <li><a href="#" data-modal-target="safety-modal"><i
                                    class="fas fa-shield-alt"></i><span>Safety</span><i
                                    class="fas fa-chevron-right chevron"></i></a></li>
                        <li><a href="#" data-modal-target="refer-modal"><i class="fas fa-gift"></i><span>Refer and
                                    Earn</span><i class="fas fa-chevron-right chevron"></i></a></li>
                        <li><a href="#" data-modal-target="rewards-modal"><i class="fas fa-trophy"></i><span>My
                                    Rewards</span><i class="fas fa-chevron-right chevron"></i></a></li>
                        <li><a href="#" data-modal-target="pass-modal"><i class="fas fa-ticket-alt"></i><span>Power
                                    Pass</span><i class="fas fa-chevron-right chevron"></i></a></li>
                        <li class="logout-item">
                            <!-- Moved logout button here -->
                            <a href="#" id="nav-logout-btn">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </a>
                        </li>
                    </ul>
                    <!-- === END NEW MENU === -->
                </li>
            </ul>
        </div>
        <!-- === END NEW WRAPPER === -->


        <!-- === NEW: Mobile Menu Toggle Button === -->
        <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-label="Toggle navigation menu"
            aria-expanded="false">
            <i class="fas fa-bars"></i>
        </button>
        <!-- === END NEW === -->
    </nav>

    <header id="home">
        <main>
            <h1>Drive Smart. Stay Safe.</h1>
            <p>Your journey is precious. Awareness is your best defense.</p>
            <figure>
                <blockquote>"The only thing we need from your trip is your safe return."</blockquote>
            </figure>
        </main>
    </header>

    <main class="content">
        <div class="flex-cards">
            <article class="education" id="education">
                <h2><i class="fas fa-book-open"></i> Safety Education</h2>
                <div class="edu-item" tabindex="0">
                    <div class="edu-title"><i class="fas fa-car-crash"></i> Understanding Blind Spots</div>
                    <i class="fas fa-chevron-right edu-chevron"></i>
                </div>
                <div class="edu-details">
                    <p>A blind spot is an area around a vehicle that the driver cannot see through their mirrors or by
                        looking directly. These hidden zones can exist on both sides of the car, behind it, and
                        sometimes even in front of large vehicles like trucks and buses. Blind spots are dangerous
                        because another vehicle, a cyclist, or a pedestrian can be present without the driver realizing
                        it. Many crashes happen when drivers change lanes or turn without checking these areas properly.
                        To stay safe, drivers should always adjust their mirrors correctly, look over their shoulder
                        before switching lanes, and be extra careful around heavy vehicles, which have much bigger blind
                        spots. Road users like cyclists and pedestrians should also avoid staying close to the sides of
                        large vehicles. Understanding blind spots helps everyone share the road more safely and prevent
                        accidents.</p>
                </div>
                <div class="edu-item" tabindex="0">
                    <div class="edu-title"><i class="fas fa-road"></i> Hydroplaning Explained</div>
                    <i class="fas fa-chevron-right edu-chevron"></i>
                </div>
                <div class="edu-details">
                    <p>Hydroplaning (or aquaplaning) happens when a vehicle’s tires lose contact with the road due to a
                        layer of water between the tire and the surface. This causes the vehicle to “float” on water,
                        reducing the driver’s ability to steer, brake, or control speed. Hydroplaning usually occurs at
                        higher speeds on wet roads, especially when tires are worn-out or water on the road is deep. To
                        prevent hydroplaning, drivers should slow down during rain, maintain proper tire pressure, avoid
                        sudden turns or braking, and stay away from areas where water collects.</p>
                </div>
            </article>

            <article class="tips" id="tips">
                <h2><i class="fas fa-lightbulb"></i> Top Safety Tips</h2>
                <div class="tip" tabindex="0">
                    <div class="tip-title"><i class="fas fa-mobile-alt"></i> Avoid Distractions</div>
                    <i class="fas fa-chevron-right tip-chevron"></i>
                </div>
                <div class="tip-details">
                    <p>Avoiding distractions while driving is essential for road safety. Drivers should keep their
                        phones away, avoid multitasking like eating or adjusting controls while the vehicle is moving,
                        and set up mirrors, navigation, and music before starting the journey. Passengers, children, or
                        pets should be managed so they do not divert the driver’s attention. If phone use or any other
                        task becomes necessary, it is always safer to pull over first. Even a moment of distraction can
                        lead to a serious crash, so staying focused on the road is the key to preventing accidents.</p>
                </div>
                <div class="tip" tabindex="0">
                    <div class="tip-title"><i class="fas fa-tachometer-alt"></i> Watch Your Speed</div>
                    <i class="fas fa-chevron-right tip-chevron"></i>
                </div>
                <div class="tip-details">
                    <p>Controlling your speed is one of the most important aspects of safe driving. Driving too fast
                        reduces your reaction time and increases the distance your vehicle travels before you can
                        stop—this means hazards that you might otherwise avoid become much more dangerous. Roads vary in
                        surface, condition, and layout, so even the posted speed limit may be too fast under certain
                        conditions like rain, fog, heavy traffic, or when sharing the road with pedestrians and
                        cyclists. Always adjust your speed to suit the conditions, anticipate hazards ahead, and
                        maintain safe following distance. By doing so, you give yourself a better chance to respond
                        safely and avoid serious accidents.</p>
                </div>
            </article>
        </div>

        <!-- 
            FIX: REMOVED DUPLICATE COMMUNITY SECTION. 
            The section below is the correct, complete one.
        -->

        <section class="community-box" id="community">

            <!-- View 1: Logged OUT (NEW) -->
            <div id="community-login-prompt">
                <h2><i class="fas fa-users"></i> Join Our Safety Community</h2>
                <p>Register or log in to get localized alerts, contribute to safer roads, and access community features.
                </p>
                <div class="community-login-btns">
                    <button id="community-signup-btn" class="btn btn-primary"
                        onclick="document.getElementById('nav-signup-btn').click();">Sign Up Now</button>
                    <button id="community-login-btn" class="btn btn-secondary"
                        onclick="document.getElementById('nav-login-btn').click();">Login</button>
                </div>
            </div>

            <!-- View 2: Logged IN, No Role Selected (MOVED) -->
            <div id="community-register-view" style="display: none;">
                <h2 id="community-register-title"><i class="fas fa-users"></i> Join Our Safety Community</h2>
                <p id="community-register-subtitle">Register as a community driver or an emergency responder to get
                    localized alerts and contribute to safer
                    roads for everyone.</p>
                <div class="registration-options">
                    <div class="reg-card driver" data-form-type="driver">
                        <div class="reg-card-icon"><i class="fas fa-car"></i></div>
                        <h3>Driver Registration</h3>
                        <p>Get alerts on road conditions, accidents, and construction in your area. Report hazards and
                            help
                            others.</p>
                        <button class="reg-btn">Register as Driver</button>
                    </div>

                    <!-- === NEW TRAVELER CARD === -->
                    <div class="reg-card traveler" data-form-type="traveler">
                        <div class="reg-card-icon"><i class="fas fa-user-plus"></i></div>
                        <h3>Community Registration</h3>
                        <p>Register as a traveler to book cabs, bikes, and other registered vehicles from our community.
                        </p>
                        <button class="reg-btn">Register as Traveler</button>
                    </div>
                    <!-- === END NEW TRAVELER CARD === -->

                    <div class="reg-card emergency" data-form-type="emergency">
                        <div class="reg-card-icon"><i class="fas fa-first-aid"></i></div>
                        <h3>Emergency Services</h3>
                        <p>Register your service to get priority access to AI-optimized routes and real-time incident
                            data.
                        </p>
                        <button class="reg-btn">Register Service</button>
                    </div>
                </div>
            </div> <!-- End register view -->

            <!-- View 3: Logged IN, Role Selected (MOVED) -->
            <div id="community-profile-view" style="display: none;"> <!-- Class will be added by JS -->
                <h2><i class="fas fa-user-check"></i> Welcome to the Community!</h2>
                <p style="font-size: 1.2em;">You are logged in as: <strong id="community-profile-name"></strong></p>

                <!-- === NEW: On Duty Toggle === -->
                <div id="on-duty-toggle-container" class="on-duty-toggle-container" style="display: none;">
                    <span id="on-duty-status-text" class="off-duty">Off Duty</span>
                    <label class="duty-toggle">
                        <input type="checkbox" id="on-duty-toggle">
                        <span class="duty-toggle-slider"></span>
                    </label>
                </div>
                <!-- === END NEW === -->

                <!-- === NEW: Role Action Buttons === -->
                <div class="profile-action-buttons">
                    <!-- Traveler Buttons -->
                    <div id="traveler-actions" class="role-actions" style="display: none;">
                        <button id="book-my-ride-btn" class="profile-btn profile-btn-traveler">
                            <i class="fas fa-taxi"></i> Book My Ride
                        </button>
                    </div>
                    <!-- Driver Buttons -->
                    <div id="driver-actions" class="role-actions" style="display: none;">
                        <button id="view-ride-requests-btn" class="profile-btn profile-btn-driver">
                            <i class="fas fa-list-alt"></i> View Ride Requests
                        </button>
                    </div>
                    <!-- Emergency Buttons -->
                    <div id="emergency-actions" class="role-actions" style="display: none;">
                        <button id="view-active-alerts-btn" class="profile-btn profile-btn-emergency">
                            <i class="fas fa-exclamation-triangle"></i> View Active Alerts
                        </button>
                        <button id="get-priority-route-btn" class="profile-btn profile-btn-emergency"
                            style="background-color: #555;">
                            <i class="fas fa-route"></i> Get Priority Route
                        </button>
                    </div>
                </div>
                <!-- === END NEW === -->
            </div>
        </section>


        <section class="pledge-box" id="pledge">
            <h2><i class="fas fa-hands-helping"></i> Take the Road Safety Pledge</h2>
            <p>Enter your name below and commit to safer roads for everyone. Let's drive responsibly!</p>
            <div class="pledge-form-group">
                <label for="pledge-name">Your Name:</label>
                <input type="text" id="pledge-name" placeholder="Eg : vivek yadav "
                    aria-label="Enter your name for the pledge">
                <button id="generate-pledge-btn" aria-label="Generate my road safety pledge">Generate Pledge</button>
            </div>
            <div id="pledge-output" class="pledge-output">
                <p>
                    <strong>This pledge is not just a promise,</strong>
                    It is a movement</em> —<br>
                    a movement that begins with one responsible citizen…<br>
                    <strong>And Today</strong>, that responsible citizen is <strong><em>YOU</em>.</strong><br>
                    <strong>Your decision</strong> can influence others,<br>
                    <em>Your voice</em> can inspire change,<br>
                    and <strong><em>Your action</em> can save lives.</strong>
                </p>
            </div>
        </section>

    </main>

    <!-- Hidden File Inputs for Profile Photo -->
    <input type="file" id="photo-gallery-input" accept="image/*" style="display: none;">
    <input type="file" id="photo-camera-input" accept="image/*" capture="user" style="display: none;">

    <!-- === NEW: Custom Alert Modal === -->
    <div id="custom-alert-modal" class="profile-modal-overlay" style="z-index: 10001;"> <!-- Highest z-index -->
        <div class="profile-modal-content" style="max-width: 400px; text-align: center;">
            <span class="profile-modal-close">&times;</span>
            <div id="custom-alert-icon" style="font-size: 3em; margin-bottom: 15px;">
                <!-- Icon will be set by JS -->
            </div>
            <h3 id="custom-alert-title" style="font-size: 1.5em; color: var(--secondary-color); margin-bottom: 10px;">
            </h3>
            <p id="custom-alert-message" style="font-size: 1em; color: #555; line-height: 1.6;"></p>
            <button id="custom-alert-close-btn" class="submit-btn" style="margin-top: 20px;">OK</button>
        </div>
    </div>
    <!-- === END Custom Alert Modal === -->


    <!-- 
        FIX: The broken HTML fragment that was here has been removed.
        The block below is the correct, functioning modal.
    -->
    <div class="reg-modal-overlay" id="reg-modal">
        <div class="reg-form-container">
            <span class="reg-form-close">&times;</span>

            <!-- === LOGIN FORM === -->
            <div id="login-form-wrapper">
                <div class="reg-form-header">
                    <h2>Community Login</h2>
                    <p>Welcome back! Sign in to access your account.</p>
                </div>
                <form id="login-form">
                    <div class="form-group">
                        <label for="loginEmail"><i class="fas fa-envelope"></i>Email</label>
                        <input type="email" id="loginEmail" name="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword"><i class="fas fa-lock"></i>Password</label>
                        <input type="password" id="loginPassword" name="loginPassword" required>
                    </div>
                    <div id="login-error" class="form-error"></div>
                    <button type="submit" class="submit-btn driver-btn" style="background: #007bff;">Login</button>
                </form>
            </div>

            <!-- === NEW SIGNUP FORM === -->
            <div id="signup-form-wrapper">
                <div class="reg-form-header">
                    <h2>Create Your Account</h2>
                    <p>Sign up to join the community. It's fast and free.</p>
                </div>
                <form id="signup-form">
                    <div class="form-group">
                        <label for="signupEmail"><i class="fas fa-envelope"></i>Email</label>
                        <input type="email" id="signupEmail" name="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword"><i class="fas fa-lock"></i>Password</label>
                        <!-- MODIFIED: Removed text -->
                        <input type="password" id="signupPassword" name="signupPassword" required minlength="8">
                        <!-- MODIFIED: minlength 8 -->

                        <!-- NEW: Password Instructions -->
                        <div id="password-instructions" class="password-instructions">
                            <h4>Password must contain:</h4>
                            <ul>
                                <li id="pass-length">At least 8 characters</li>
                                <li id="pass-lower">At least one lowercase letter (a-z)</li>
                                <li id="pass-upper">At least one uppercase letter (A-Z)</li>
                                <li id="pass-number">At least one number (0-9)</li>
                                <li id="pass-special">At least one special character (!, @, #, etc.)</li>
                            </ul>
                        </div>
                        <!-- END NEW -->

                    </div>
                    <div class="form-group">
                        <label for="signupConfirmPassword"><i class="fas fa-check-circle"></i>Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" name="signupConfirmPassword" required
                            minlength="8"> <!-- MODIFIED: minlength 8 -->
                    </div>
                    <div id="signup-error" class="form-error"></div>
                    <button type="submit" class="submit-btn driver-btn" style="background: var(--primary-color);">Create
                        Account</button>
                </form>
            </div>

            <!-- === DRIVER REGISTRATION FORM (Role Completion) === -->
            <div id="driver-form-wrapper">
                <div class="reg-form-header">
                    <h2 id="reg-form-title-driver">Complete Driver Profile</h2>
                    <p id="reg-form-subtitle-driver">Please provide your driver and vehicle details.</p>
                </div>
                <form id="driver-registration-form">
                    <!-- === NEW CIRCULAR PHOTO UPLOADER === -->
                    <div class="profile-photo-uploader" id="driver-photo-uploader-port"
                        title="Click to add profile photo">
                        <i class="fas fa-camera upload-icon" id="driver-photo-icon"></i>
                        <img src="#" alt="Profile Preview" class="photo-preview" id="driver-photo-preview">
                    </div>
                    <input type="file" id="driver-photo-input-hidden" accept="image/*" style="display: none;">
                    <!-- === END NEW === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Personal Details</h3>
                    <div class="form-group">
                        <label for="driverName"><i class="fas fa-user"></i>Full Name</label>
                        <input type="text" id="driverName" name="driverName" required>
                    </div>
                    <div class="form-group">
                        <label for="driverPhone"><i class="fas fa-phone"></i>Phone Number</label>
                        <input type="tel" id="driverPhone" name="driverPhone" required>
                    </div>
                    <!-- === NEW: Gender === -->
                    <div class="form-group">
                        <label><i class="fas fa-venus-mars"></i>Gender</label>
                        <div class="gender-button-group" id="driver-gender-group">
                            <button type="button" class="gender-btn" data-value="male"><i class="fas fa-mars"></i>
                                Male</button>
                            <button type="button" class="gender-btn" data-value="female"><i class="fas fa-venus"></i>
                                Female</button>
                        </div>
                        <input type="hidden" id="driverGender" name="gender" value="">
                    </div>
                    <!-- === END NEW === -->
                    <!-- === REMOVED OLD PHOTO INPUT === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Vehicle Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vehicleType"><i class="fas fa-car-side"></i>Vehicle Type</label>
                            <select id="vehicleType" name="vehicleType">
                                <option value="car">Car</option>
                                <option value="motorcycle">Motorcycle</option>
                                <option value="truck">Truck</option>
                                <option value="bus">Bus</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="licensePlate"><i class="fas fa-id-card"></i>License Plate</label>
                            <input type="text" id="licensePlate" name="licensePlate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vehicleMake"><i class="fas fa-industry"></i>Vehicle Make</label>
                            <input type="text" id="vehicleMake" name="vehicleMake" placeholder="e.g., Toyota">
                        </div>
                        <div class="form-group">
                            <label for="vehicleModel"><i class="fas fa-car"></i>Vehicle Model</label>
                            <input type="text" id="vehicleModel" name="vehicleModel" placeholder="e.g., Camry">
                        </div>
                    </div>

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Trip Details</h3>
                    <div class="form-group">
                        <label for="baseLocation"><i class="fas fa-map-marker-alt"></i>Base Location / City</label>
                        <!-- <-- MODIFIED -->
                        <input type="text" id="baseLocation" name="baseLocation" <!-- <-- MODIFIED -->
                        placeholder="e.g., Gurugram"> <!-- <-- MODIFIED -->
                    </div>
                    <!-- New Map Preview Button -->
                    <button type="button" id="previewDriverMapBtn" class="submit-btn map-preview-btn">
                        <i class="fas fa-map-marked-alt"></i> Preview Map
                    </button>
                    <!-- New Map Container -->
                    <div id="driver-map-container" class="map-container" style="display: none;"></div>

                    <div id="driver-reg-error" class="form-error"></div>
                    <button type="submit" class="submit-btn driver-btn">Register Driver</button>
                </form>
            </div>

            <!-- === TRAVELER REGISTRATION FORM (Role Completion) === -->
            <div id="traveler-form-wrapper">
                <div class="reg-form-header">
                    <h2 id="reg-form-title-traveler">Complete Traveler Profile</h2>
                    <p id="reg-form-subtitle-traveler">Tell us a bit about yourself.</p>
                </div>
                <form id="traveler-registration-form">
                    <!-- === NEW CIRCULAR PHOTO UPLOADER === -->
                    <div class="profile-photo-uploader" id="traveler-photo-uploader-port"
                        title="Click to add profile photo">
                        <i class="fas fa-camera upload-icon" id="traveler-photo-icon"></i>
                        <img src="#" alt="Profile Preview" class="photo-preview" id="traveler-photo-preview">
                    </div>
                    <input type="file" id="traveler-photo-input-hidden" accept="image/*" style="display: none;">
                    <!-- === END NEW === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Personal Details</h3>
                    <div class="form-group">
                        <label for="travelerName"><i class="fas fa-user"></i>Full Name</label>
                        <input type="text" id="travelerName" name="travelerName" required>
                    </div>
                    <div class="form-group">
                        <label for="travelerPhone"><i class="fas fa-phone"></i>Phone Number</label>
                        <input type="tel" id="travelerPhone" name="travelerPhone" required>
                    </div>
                    <!-- === NEW: Gender === -->
                    <div class="form-group">
                        <label><i class="fas fa-venus-mars"></i>Gender</label>
                        <div class="gender-button-group" id="traveler-gender-group">
                            <button type="button" class="gender-btn" data-value="male"><i class="fas fa-mars"></i>
                                Male</button>
                            <button type="button" class="gender-btn" data-value="female"><i class="fas fa-venus"></i>
                                Female</button>
                        </div>
                        <input type="hidden" id="travelerGender" name="gender" value="">
                    </div>
                    <!-- === END NEW === -->
                    <!-- === REMOVED OLD PHOTO INPUT === -->
                    <div class="form-group">
                        <label for="travelerLocation"><i class="fas fa-map-marker-alt"></i>Default Pickup Location
                            (Optional)</label>
                        <input type="text" id="travelerLocation" name="travelerLocation"
                            placeholder="Enter your home or work address">
                    </div>

                    <div id="traveler-reg-error" class="form-error"></div>
                    <button type="submit" class="submit-btn traveler-btn">Register as Traveler</button>
                </form>
            </div>
            <!-- === END TRAVELER REGISTRATION FORM === -->

            <!-- === EMERGENCY REGISTRATION FORM (Role Completion) === -->
            <div id="emergency-form-wrapper">
                <div class="reg-form-header">
                    <h2 id="reg-form-title-emergency">Complete Service Profile</h2>
                    <p id="reg-form-subtitle-emergency">Register your service for priority routing.</p>
                </div>
                <form id="emergency-registration-form">
                    <!-- === NEW CIRCULAR PHOTO UPLOADER === -->
                    <div class="profile-photo-uploader" id="emergency-photo-uploader-port"
                        title="Click to add profile photo">
                        <i class="fas fa-camera upload-icon" id="emergency-photo-icon"></i>
                        <img src="#" alt="Profile Preview" class="photo-preview" id="emergency-photo-preview">
                    </div>
                    <input type="file" id="emergency-photo-input-hidden" accept="image/*" style="display: none;">
                    <!-- === END NEW === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Service Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="serviceType"><i class="fas fa-briefcase-medical"></i>Service Type</label>
                            <select id="serviceType" name="serviceType">
                                <option value="ambulance">Ambulance</option>
                                <option value="police">Police</option>
                                <option value="fire">Fire Dept.</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="serviceId"><i class="fas fa-id-badge"></i>Service ID / Unit No.</label>
                            <input type="text" id="serviceId" name="serviceId" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="serviceName"><i class="fas fa-user-md"></i>Operator Name</label>
                        <input type="text" id="serviceName" name="serviceName" required>
                    </div>
                    <div class="form-group">
                        <label for="servicePhone"><i class="fas fa-phone-alt"></i>Dispatch Phone</label>
                        <input type="tel" id="servicePhone" name="servicePhone" required>
                    </div>
                    <!-- === NEW: Gender === -->
                    <div class="form-group">
                        <label><i class="fas fa-venus-mars"></i>Gender</label>
                        <div class="gender-button-group" id="emergency-gender-group">
                            <button type="button" class="gender-btn" data-value="male"><i class="fas fa-mars"></i>
                                Male</button>
                            <button type="button" class="gender-btn" data-value="female"><i class="fas fa-venus"></i>
                                Female</button>
                        </div>
                        <input type="hidden" id="emergencyGender" name="gender" value="">
                    </div>
                    <!-- === END NEW === -->
                    <!-- === REMOVED OLD PHOTO INPUT === -->

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Vehicle Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="serviceVehicleId"><i class="fas fa-car"></i>Vehicle ID / Plate</label>
                            <input type="text" id="serviceVehicleId" name="serviceVehicleId" required>
                        </div>
                        <div class="form-group">
                            <label for="serviceVehicleType"><i class="fas fa-ambulance"></i>Vehicle Type</label>
                            <input type="text" id="serviceVehicleType" name="serviceVehicleType"
                                placeholder="e.g., Type II Ambulance">
                        </div>
                    </div>

                    <h3
                        style="font-weight: 600; color: #333; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        Routing Details</h3>
                    <div class="form-group">
                        <label for="baseLocation"><i class="fas fa-map-marked-alt"></i>Base Location / City</label>
                        <!-- <-- MODIFIED -->
                        <input type="text" id="baseLocation" name="baseLocation" <!-- <-- MODIFIED -->
                        placeholder="e.g., Gurugram"> <!-- <-- MODIFIED -->
                    </div>
                    <!-- New Map Preview Button -->
                    <button type="button" id="previewEmergencyMapBtn" class="submit-btn map-preview-btn">
                        <i class="fas fa-map-marked-alt"></i> Preview Map
                    </button>
                    <!-- New Map Container -->
                    <div id="emergency-map-container" class="map-container" style="display: none;"></div>

                    <div class="form-group-checkbox">
                        <input type="checkbox" id="bestRoute" name="bestRoute">
                        <label for="bestRoute">Give best possible route option</label>
                    </div>

                    <div id="emergency-reg-error" class="form-error"></div>
                    <button type="submit" class="submit-btn emergency-btn">Register Service</button>
                </form>
            </div>

            <!-- === SUCCESS MESSAGES === -->
            <div class="success-message" id="driver-success-message">
                <i class="fas fa-check-circle"></i>
                <h3>Registration Successful!</h3>
                <p>Thank you for joining the driver community.</p>
            </div>
            <div class="success-message" id="emergency-success-message">
                <i class="fas fa-check-circle" style="color: var(--primary-color);"></i>
                <h3>Service Registered!</h3>
                <p>Your unit is now active. Thank you for your service.</p>
            </div>

            <!-- === TRAVELER SUCCESS MESSAGE === -->
            <div class="success-message" id="traveler-success-message">
                <i class="fas fa-check-circle" style="color: #007bff;"></i>
                <h3>Welcome to the Community!</h3>
                <p>You can now book rides from registered community vehicles.</p>
            </div>
            <!-- === END TRAVELER SUCCESS MESSAGE === -->

        </div>
    </div>

    <!-- === NEW: Profile Modals === -->

    <!-- My Rating Modal -->
    <div id="rating-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>

            <!-- Rating Content -->
            <div id="rating-content">
                <h2><i class="fas fa-star"></i> Rate Your Experience</h2>
                <p>We value your feedback. Please rate your experience with safe return and leave a comment below.</p>

                <div class="star-rating-container" data-rating="0">
                    <span class="star" data-value="1"><i class="fas fa-star"></i></span>
                    <span class="star" data-value="2"><i class="fas fa-star"></i></span>
                    <span class="star" data-value="3"><i class="fas fa-star"></i></span>
                    <span class="star" data-value="4"><i class="fas fa-star"></i></span>
                    <span class="star" data-value="5"><i class="fas fa-star"></i></span>
                </div>

                <textarea id="review-comment" class="review-textarea"
                    placeholder="Write your review here... (optional)"></textarea>

                <button id="submit-review-btn" class="submit-review-btn">Submit Review</button>
            </div>

            <!-- Success Message -->
            <div id="rating-success-message" class="success-message" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <h3>Thank You!</h3>
                <p>Your review has been submitted successfully.</p>
            </div>

        </div> <!-- Closes profile-modal-content -->
    </div> <!-- Closes rating-modal -->

    <!-- Help Modal -->
    <div id="help-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-question-circle"></i> Help & Support</h2>
            <p>Have questions? Find answers to common queries below or contact our support team.</p>

            <div class="faq-accordion" id="faq-accordion">
                <!-- FAQ Item 1 -->
                <div class="faq-item">
                    <div class="faq-title" tabindex="0">
                        How do I book a ride?
                        <i class="fas fa-chevron-right faq-chevron"></i>
                    </div>
                    <div class="faq-details">
                        <p>You can book a ride by logging in, selecting the "Traveler" role, and clicking the "Book My Ride" button on your profile. This will open a modal where you can enter your pickup and drop-off locations.</p>
                    </div>
                </div>
                <!-- FAQ Item 2 -->
                <div class="faq-item">
                    <div class="faq-title" tabindex="0">
                        How does the Women Shield work?
                        <i class="fas fa-chevron-right faq-chevron"></i>
                    </div>
                    <div class="faq-details">
                        <p>The Women Shield is a safety feature for female users. Once activated (after registering as female), the "Women Shield" link in the navigation will blink. Clicking it provides access to female-only drivers, ride-sharing with verified female co-passengers, and a direct-line SOS feature.</p>
                    </div>
                </div>
                <!-- FAQ Item 3 -->
                <div class="faq-item">
                    <div class="faq-title" tabindex="0">
                        How do I add money to my wallet?
                        <i class="fas fa-chevron-right faq-chevron"></i>
                    </div>
                    <div class="faq-details">
                        <p>Click on your profile icon, select "Wallet" from the dropdown. In the wallet modal, you can see your balance and an "Add Money" button. This will open a secure form to add funds.</p>
                    </div>
                </div>
                <!-- FAQ Item 4 -->
                <div class="faq-item">
                    <div class="faq-title" tabindex="0">
                        I'm a driver, how do I get rides?
                        <i class="fas fa-chevron-right faq-chevron"></i>
                    </div>
                    <div class="faq-details">
                        <p>First, make sure you are registered as a driver. Then, on your profile, toggle your status to "On Duty". You will then be able to see available "Ride Requests" and make offers. If a traveler accepts your offer, you will be notified.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet/Payment Modal -->
    <div id="payment-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-credit-card"></i> Wallet & Payments</h2>

            <div class="wallet-balance">
                <p>Your Wallet Balance</p>
                <h3 id="wallet-balance-amount">₹0.00</h3>
            </div>

            <button id="add-money-toggle-btn" class="add-money-btn">
                <i class="fas fa-plus-circle"></i> Add Money
            </button>

            <div id="add-money-section">
                <form id="add-money-form">
                    <div class="form-group">
                        <label for="add-money-amount">Amount (₹)</label>
                        <input type="number" id="add-money-amount" placeholder="Enter amount" min="10" required>
                    </div>
                    <button type="submit" class="submit-btn">Proceed to Payment</button>
                </form>
            </div>

            <h4>Saved Payment Methods</h4>
            <div id="saved-payment-methods-list">
                <!-- Example item, can be populated by JS -->
                <div class="saved-payment-method">
                    <div class="icon"><i class="fab fa-cc-visa"></i></div>
                    <div class="details">
                        <p>Visa ... 4242</p>
                        <span>Expires 12/26</span>
                    </div>
                    <button class="remove-btn">Remove</button>
                </div>
            </div>
            <p style="text-align: center; color: #777; font-size: 0.9em; margin-top: 15px;">+ Add New Card</p>
        </div>
    </div>

    <!-- My Rides Modal -->
    <div id="rides-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-route"></i> My Rides</h2>
            <p>Here is a history of your recent rides with SafeReturn.</p>
            <ul class="ride-history-list" id="ride-history-list-content">
                <!-- JS will populate this -->
                <li style="text-align: center; color: #777;">Loading ride history...</li>
            </ul>
        </div>
    </div>

    <!-- Safety Modal -->
    <div id="safety-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-shield-alt"></i> Safety Center</h2>
            <p>Your safety is our top priority. Use these features in case of an emergency or to learn more.</p>

            <div class="safety-features">
                <button class="safety-feature-btn share-btn" id="share-ride-btn">
                    <i class="fas fa-share-alt"></i>
                    <span>Share Ride Status</span>
                </button>
                <button class="safety-feature-btn sos-btn" id="sos-btn">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Send SOS Alert</span>
                </button>
            </div>

            <h4>Safety Tips</h4>
            <ul class="safety-tips-list">
                <li><i class="fas fa-check-circle"></i> Always verify the driver and vehicle details before starting your ride.</li>
                <li><i class="fas fa-check-circle"></i> Share your ride status with trusted contacts.</li>
                <li><i class="fas fa-check-circle"></i> Sit in the back seat if possible.</li>
                <li><i class="fas fa-check-circle"></i> If you feel unsafe, use the SOS button immediately.</li>
            </ul>
        </div>
    </div>

    <!-- Refer and Earn Modal -->
    <div id="refer-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-gift"></i> Refer and Earn</h2>
            <p>Share your referral code with friends. When they sign up and complete their first ride, you both get a reward!</p>

            <div class="referral-code-box">
                <input type="text" id="referral-code" value="LOGIN-TO-SEE" readonly>
                <button id="referral-copy-btn"><i class="fas fa-copy"></i></button>
            </div>

            <p style="text-align: center; font-weight: 600;">Share via:</p>
            <div class="social-share-buttons">
                <a href="#" class="social-share-btn whatsapp" aria-label="Share on WhatsApp"><i class="fab fa-whatsapp"></i></a>
                <a href="#" class="social-share-btn twitter" aria-label="Share on Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" class="social-share-btn facebook" aria-label="Share on Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="social-share-btn sms" aria-label="Share via SMS"><i class="fas fa-comment-dots"></i></a>
            </div>
        </div>
    </div>

    <!-- My Rewards Modal -->
    <div id="rewards-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-trophy"></i> My Rewards</h2>
            <p>Here are your available rewards and offers. Click to claim!</p>
            <ul class="rewards-list" id="rewards-list-content">
                <!-- JS will populate this -->
                <li style="text-align: center; color: #777;">Loading rewards...</li>
            </ul>
        </div>
    </div>

    <!-- Power Pass Modal -->
    <div id="pass-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-ticket-alt"></i> Power Pass</h2>
            <p>Unlock premium benefits with the SafeReturn Power Pass! Get priority support, exclusive discounts, and more.</p>
            <div style="background: #f0f0f0; padding: 20px; border-radius: 8px; text-align: center; margin-top: 20px;">
                <h3>Coming Soon!</h3>
                <p>We're working on bringing you even more value. Stay tuned!</p>
            </div>
        </div>
    </div>

    <!-- === TRAVELER MODALS === -->

    <!-- Book My Ride Modal (Traveler) -->
    <div id="book-ride-modal" class="profile-modal-overlay">
        <div class="profile-modal-content" style="max-width: 550px;">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-taxi"></i> Book Your Ride</h2>
            <p>Enter your pickup and drop-off locations to see available drivers.</p>
            <form id="book-ride-form">
                <div class="form-group">
                    <label for="ride-from"><i class="fas fa-map-marker-alt"></i> From:</label>
                    <input type="text" id="ride-from" name="ride-from" placeholder="Enter pickup location" required>
                </div>
                <div class="form-group">
                    <label for="ride-to"><i class="fas fa-map-pin"></i> To:</label>
                    <input type="text" id="ride-to" name="ride-to" placeholder="Enter drop-off location" required>
                </div>
                <div class="form-group">
                    <label for="ride-fare"><i class="fas fa-rupee-sign"></i> Your Offer (Optional):</label>
                    <input type="number" id="ride-fare" name="ride-fare" placeholder="Enter fare you are willing to pay">
                </div>
                <div id="book-ride-error" class="modal-form-error"></div>
                <button type="submit" class="submit-btn traveler-btn" style="width: 100%;">
                    <i class="fas fa-search"></i> Find Drivers
                </button>
            </form>
        </div>
    </div>

    <!-- Bidding Modal (Traveler) -->
    <div id="bidding-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-gavel"></i> Waiting for Bids...</h2>
            <p>Your request has been sent. Drivers will now bid on your ride. Please wait...</p>
            <div class="bids-list-container">
                <ul class="bids-list" id="bids-list-content">
                    <!-- Bids will be populated by JS -->
                    <li style="text-align: center; color: #777; padding: 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 1.5em;"></i>
                        <p style="margin-top: 10px;">Listening for nearby drivers...</p>
                    </li>
                </ul>
            </div>
            <button id="cancel-ride-request-btn" class="submit-btn" style="background: #777; width: 100%; margin-top: 15px;">
                Cancel Request
            </button>
        </div>
    </div>

    <!-- Tracking Modal (Traveler) -->
    <div id="tracking-modal" class="profile-modal-overlay">
        <div class="profile-modal-content">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-map-marked-alt"></i> Driver is on the way!</h2>
            <p>Your ride is confirmed. You can track your driver in real-time below.</p>
            
            <div class="tracking-map-container">
                <div id="tracking-map">
                    <!-- Map will be loaded here by JS -->
                    <p>Initializing map...</p>
                </div>
            </div>

            <div id="tracking-driver-info">
                <h4>Driver: <span id="tracking-driver-name">...</span></h4>
                <p>Vehicle: <span id="tracking-driver-vehicle">...</span></p>
                <p>License: <span id="tracking-driver-license">...</span></p>
                <p style="margin-top: 10px; font-weight: 600;">Status: <span id="tracking-driver-status">En route...</span></p>
            </div>
        </div>
    </div>

    <!-- Ride Complete Modal (Traveler) -->
    <div id="ride-complete-modal" class="profile-modal-overlay">
        <div class="profile-modal-content" style="text-align: center;">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-check-circle"></i> Ride Complete!</h2>
            <p>You have reached your destination.</p>

            <div class="ride-summary">
                <p>Total Fare</p>
                <h3 id="final-fare-amount">₹150.00</h3>
            </div>
            
            <button id="rate-driver-btn" class="submit-btn traveler-btn" style="width: 100%;">
                <i class="fas fa-star"></i> Rate Your Driver
            </button>
        </div>
    </div>

    <!-- === DRIVER MODALS === -->

    <!-- View Ride Requests Modal (Driver) -->
    <div id="ride-requests-modal" class="profile-modal-overlay">
        <div class="profile-modal-content" style="max-width: 600px;">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-list-alt"></i> Active Ride Requests</h2>
            <p>Here are the ride requests available in your area. Click to make an offer.</p>
            <ul class="modal-list" id="ride-requests-list-content">
                <!-- JS will populate this -->
                <li style="text-align: center; color: #777;">Listening for ride requests...</li>
            </ul>
        </div>
    </div>

    <!-- Make Offer Modal (Driver) -->
    <div id="make-offer-modal" class="profile-modal-overlay">
        <div class="profile-modal-content" style="max-width: 500px;">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-tag"></i> Make an Offer</h2>
            <div id="offer-ride-details" style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0;"><strong>From:</strong> <span id="offer-ride-from">...</span></p>
                <p style="margin: 0;"><strong>To:</strong> <span id="offer-ride-to">...</span></p>
                <p style="margin: 0;"><strong>Traveler Offer:</strong> <span id="offer-ride-fare">...</span></p>
            </div>
            <form id="make-offer-form">
                <div class="form-group">
                    <label for="driver-bid-amount"><i class="fas fa-rupee-sign"></i> Your Bid Amount:</label>
                    <input type="number" id="driver-bid-amount" name="driver-bid-amount" placeholder="Enter your bid" required>
                </div>
                <input type="hidden" id="offer-ride-request-id" value="">
                <div id="make-offer-error" class="modal-form-error"></div>
                <button type="submit" class="submit-btn driver-btn" style="width: 100%;">
                    Submit Offer
                </button>
            </form>
        </div>
    </div>
    
    <!-- New Pickup Modal (Driver) -->
    <div id="new-pickup-modal" class="profile-modal-overlay">
        <div class="profile-modal-content" style="text-align: center;">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-bell"></i> New Pickup!</h2>
            <p>A traveler has accepted your offer. Please proceed to the pickup location.</p>
            
            <div class="details-grid">
                <p><strong>Traveler:</strong> <span id="pickup-traveler-name">...</span></p>
                <p><strong>From:</strong> <span id="pickup-traveler-from">...</span></p>
                <p><strong>To:</strong> <span id="pickup-traveler-to">...</span></p>
            </div>

            <div class="pickup-actions">
                <button id="end-ride-btn" class="submit-btn" style="display: none;">End Ride</button>
                <button id="start-ride-btn" class="submit-btn">Start Ride</button>
                <button id="cancel-ride-btn" class="submit-btn">Cancel</button>
            </div>
        </div>
    </div>


    <!-- === EMERGENCY MODALS === -->

    <!-- Active Alerts Modal (Emergency) -->
    <div id="active-alerts-modal" class="profile-modal-overlay">
        <div class="profile-modal-content" style="max-width: 600px;">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-exclamation-triangle"></i> Active Alerts</h2>
            <p>Real-time SOS alerts and accident reports in your operational area.</p>
            <ul class="modal-list" id="active-alerts-list-content">
                <!-- JS will populate this -->
                <li class="alert-item">
                    <div class="icon"><i class="fas fa-car-crash"></i></div>
                    <div class="details">
                        <p>Accident Reported</p>
                        <span>Location: NH-8, Near Cyber Hub</span>
                        <span class="timestamp">Just now</span>
                    </div>
                </li>
                <li class="alert-item">
                    <div class="icon"><i class="fas fa-user-shield"></i></div>
                    <div class="details">
                        <p>SOS Alert - Women Shield</p>
                        <span>Location: Sector 29, Gurugram</span>
                        <span class="timestamp">2 minutes ago</span>
                    </div>
                </li>
                <li style="text-align: center; color: #777;">Listening for alerts...</li>
            </ul>
        </div>
    </div>

    <!-- Priority Route Modal (Emergency) -->
    <div id="priority-route-modal" class="profile-modal-overlay">
        <div class="profile-modal-content" style="max-width: 550px;">
            <span class="profile-modal-close">&times;</span>
            <h2><i class="fas fa-route"></i> Get Priority Route</h2>
            <p>Enter your destination to get an AI-optimized route with priority at smart traffic signals.</p>
            <form id="priority-route-form">
                <div class="form-group">
                    <label for="route-destination"><i class="fas fa-map-pin"></i> Destination:</label>
                    <input type="text" id="route-destination" name="route-destination" placeholder="Enter incident location or hospital" required>
                </div>
                <div id="priority-route-error" class="modal-form-error"></div>
                <button type="submit" class="submit-btn emergency-btn" style="width: 100%;">
                    <i class="fas fa-map-marked-alt"></i> Generate Route
                </button>
            </form>
        </div>
    </div>


    <!-- === END NEW Modals === -->


    <!-- Certificate Modal -->
    <div class="modal-overlay" id="certificate-modal">
        <canvas id="confetti-canvas"></canvas>
        <div class="certificate-container" id="certificate-content">
            <span class="cert-close-btn" id="cert-close-btn">&times;</span>
            <div class="certificate-header">
                <img src="Photoes/logo.png" alt="SafeReturn Logo" class="certificate-logo"
                    onerror="this.src='https://placehold.co/80x80/ffffff/E63939?text=SR'; this.onerror=null;">
                <h2>Certificate of Pledge</h2>
                <p>This certificate is proudly presented to</p>
            </div>
            <div class="certificate-body">
                <span class="cert-name" id="cert-name">Your Name Here</span>
                <p>For taking the Road Safety Pledge and committing to being a responsible road user. Your pledge contributes to a safer community for everyone.</p>
                <blockquote>
                    "I pledge to follow all traffic rules, to drive with patience and awareness, and to prioritize the safety of myself and others on the road."
                </blockquote>
            </div>
            <div class="certificate-footer">
                <div class="certificate-date">
                    <p id="cert-date">October 29, 2025</p>
                </div>
                <div class="certificate-signature">
                    <img src="Photoes/Sign.png" alt="Signature" class="signature-img"
                        onerror="this.style.display='none'">
                    <p>Director, SafeReturn Initiative</p>
                </div>
            </div>
            <div class="cert-button-group">
                <button id="download-pdf-btn" class="cert-btn"><i class="fas fa-download"></i> Download PDF</button>
                <button id="download-jpg-btn" class="cert-btn"><i class="fas fa-image"></i> Download JPG</button>
                <a id="whatsapp-share-btn" href="#" class="cert-btn fab" target="_blank"><i class="fab fa-whatsapp"></i>
                    Share</a>
            </div>
        </div>
    </div>

    <!-- Hero Modal (Welcome) -->
    <div class="modal-overlay" id="hero-modal" style="display: none;">
        <div class="hero-modal-content">
            <span id="hero-close-btn">&times;</span>
            <h2 style="font-family: 'Dancing Script', cursive; font-size: 2.5em; margin-bottom: 0;">Welcome to</h2>
            <h1 style="font-family: 'Playfair Display', serif; margin-top: 0;">SafeReturn</h1>
            <p>Your comprehensive solution for road safety awareness, community support, and smart traffic management.
            </p>
            <p classs="emphasis">Drive Smart. Stay Safe.</p>
        </div>
    </div>

    <footer id="main-footer" style="padding: 20px; text-align: center; color: #fff; background: var(--dark-bg);">
        <p>© 2025 SafeReturn Initiative. All Rights Reserved.</p>
    </footer>

    <!-- === JAVASCRIPT === -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- NEW: Custom Alert Function ---
            const customAlertModal = document.getElementById('custom-alert-modal');
            const alertCloseBtn = customAlertModal.querySelector('.profile-modal-close');
            const alertOkBtn = customAlertModal.querySelector('#custom-alert-close-btn');
            const alertIcon = document.getElementById('custom-alert-icon');
            const alertTitle = document.getElementById('custom-alert-title');
            const alertMessage = document.getElementById('custom-alert-message');

            const showAlert = (title, message, type = 'info') => {
                // Set icon based on type
                if (type === 'error') {
                    alertIcon.innerHTML = '<i class="fas fa-times-circle" style="color: var(--primary-color);"></i>';
                    alertTitle.style.color = 'var(--primary-color)';
                } else if (type === 'success') {
                    alertIcon.innerHTML = '<i class="fas fa-check-circle" style="color: var(--driver-color);"></i>';
                    alertTitle.style.color = 'var(--driver-color)';
                } else {
                    alertIcon.innerHTML = '<i class="fas fa-info-circle" style="color: var(--traveler-color);"></i>';
                    alertTitle.style.color = 'var(--traveler-color)';
                }

                alertTitle.textContent = title;
                alertMessage.textContent = message;
                customAlertModal.classList.add('active');
            };

            const closeAlert = () => {
                customAlertModal.classList.remove('active');
            };

            alertCloseBtn.addEventListener('click', closeAlert);
            alertOkBtn.addEventListener('click', closeAlert);
            customAlertModal.addEventListener('click', (e) => {
                if (e.target === customAlertModal) closeAlert();
            });

            // --- NEW: Make showAlert global ---
            window.showAlert = showAlert;

            // --- Sidebar Logic ---
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarClose = document.getElementById('sidebarClose');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            const openSidebar = () => {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
            };
            const closeSidebar = () => {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            };

            if (sidebarToggle) sidebarToggle.addEventListener('click', openSidebar);
            if (sidebarClose) sidebarClose.addEventListener('click', closeSidebar);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);

            // --- Accordion Logic (Education & Tips) ---
            const accordions = document.querySelectorAll('.edu-item, .tip');
            accordions.forEach(item => {
                const details = item.nextElementSibling;
                const chevron = item.querySelector('.edu-chevron, .tip-chevron');

                const open = () => {
                    item.classList.add('active');
                    if (chevron) chevron.style.transform = 'rotate(90deg)';
                    details.classList.add('open');
                    details.style.maxHeight = details.scrollHeight + 'px';
                };
                const close = () => {
                    item.classList.remove('active');
                    if (chevron) chevron.style.transform = 'rotate(0deg)';
                    details.classList.remove('open');
                    details.style.maxHeight = '0';
                };

                item.addEventListener('click', () => {
                    const isOpen = item.classList.contains('active');
                    // Close all others
                    accordions.forEach(other => {
                        if (other !== item) {
                            other.classList.remove('active');
                            if (other.nextElementSibling) {
                                other.nextElementSibling.style.maxHeight = '0';
                                other.nextElementSibling.classList.remove('open');
                            }
                            const otherChevron = other.querySelector('.edu-chevron, .tip-chevron');
                            if (otherChevron) otherChevron.style.transform = 'rotate(0deg)';
                        }
                    });
                    // Toggle current
                    if (isOpen) {
                        close();
                    } else {
                        open();
                    }
                });
            });

            // --- Pledge & Certificate Logic ---
            const generatePledgeBtn = document.getElementById('generate-pledge-btn');
            const pledgeNameInput = document.getElementById('pledge-name');
            const pledgeOutput = document.getElementById('pledge-output');
            const certificateModal = document.getElementById('certificate-modal');
            const certCloseBtn = document.getElementById('cert-close-btn');
            const certNameEl = document.getElementById('cert-name');
            const certDateEl = document.getElementById('cert-date');

            if (generatePledgeBtn) {
                generatePledgeBtn.addEventListener('click', () => {
                    const name = pledgeNameInput.value.trim();
                    if (name === "") {
                        // --- NEW: Use custom alert ---
                        showAlert('Error', 'Please enter your name to generate the pledge.', 'error');
                        return;
                    }
                    if (name.length > 50) {
                        // --- NEW: Use custom alert ---
                        showAlert('Error', 'Name is too long. Please use a shorter name.', 'error');
                        return;
                    }

                    // Update pledge output text
                    pledgeOutput.innerHTML = `
                        <p>
                            I, <strong>${name}</strong>, pledge to follow all traffic rules, 
                            to drive with patience and awareness, and to prioritize 
                            the safety of myself and others on the road.
                        </p>
                    `;

                    // Update and show certificate
                    certNameEl.textContent = name;
                    certDateEl.textContent = new Date().toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    if (certificateModal) certificateModal.style.display = 'flex';

                    // Trigger confetti
                    if (typeof confetti === 'function') {
                        const canvas = document.getElementById('confetti-canvas');
                        const myConfetti = confetti.create(canvas, {
                            resize: true,
                            useWorker: true
                        });
                        myConfetti({
                            particleCount: 150,
                            spread: 180,
                            origin: { y: 0.6 }
                        });
                    }
                });
            }

            if (certCloseBtn) certCloseBtn.addEventListener('click', () => {
                if (certificateModal) certificateModal.style.display = 'none';
            });

            // --- Certificate Download Logic ---
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const downloadJpgBtn = document.getElementById('download-jpg-btn');
            const certificateContent = document.getElementById('certificate-content');
            const { jsPDF } = window.jspdf;

            if (downloadPdfBtn && certificateContent && window.html2canvas && jsPDF) {
                downloadPdfBtn.addEventListener('click', () => {
                    window.html2canvas(certificateContent, { scale: 2, useCORS: true }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF({
                            orientation: 'landscape',
                            unit: 'px',
                            format: [canvas.width, canvas.height]
                        });
                        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                        pdf.save('SafeReturn_Pledge.pdf');
                    });
                });
            }

            if (downloadJpgBtn && certificateContent && window.html2canvas) {
                downloadJpgBtn.addEventListener('click', () => {
                    window.html2canvas(certificateContent, { scale: 2, useCORS: true }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = 'SafeReturn_Pledge.jpg';
                        link.href = canvas.toDataURL('image/jpeg', 0.9);
                        link.click();
                    });
                });
            }

            // --- WhatsApp Share Logic ---
            const whatsappShareBtn = document.getElementById('whatsapp-share-btn');
            if (whatsappShareBtn) {
                whatsappShareBtn.addEventListener('click', (e) => {
                    const name = pledgeNameInput.value.trim() || "I";
                    const text = encodeURIComponent(
                        `Great news! ${name} just took the SafeReturn Road Safety Pledge. Join the movement! #SafeReturn #RoadSafety`
                    );
                    e.target.href = `https://api.whatsapp.com/send?text=${text}`;
                });
            }

            // --- Hero Modal (Welcome) ---
            const heroModal = document.getElementById('hero-modal');
            const heroCloseBtn = document.getElementById('hero-close-btn');
            // Show only once using sessionStorage
            if (heroModal && !sessionStorage.getItem('heroModalShown')) {
                // setTimeout(() => {
                //     heroModal.style.display = 'flex';
                //     sessionStorage.setItem('heroModalShown', 'true');
                // }, 1500); // Show after 1.5 seconds
            }
            if (heroCloseBtn) heroCloseBtn.addEventListener('click', () => {
                if (heroModal) heroModal.style.display = 'none';
            });

            // --- NEW: Password Validation UI ---
            const signupPassword = document.getElementById('signupPassword');
            const instructions = {
                length: document.getElementById('pass-length'),
                lower: document.getElementById('pass-lower'),
                upper: document.getElementById('pass-upper'),
                number: document.getElementById('pass-number'),
                special: document.getElementById('pass-special'),
            };

            if (signupPassword && instructions.length) {
                const validate = () => {
                    const value = signupPassword.value;
                    // Length
                    if (value.length >= 8) instructions.length.classList.add('valid');
                    else instructions.length.classList.remove('valid');
                    // Lowercase
                    if (/[a-z]/.test(value)) instructions.lower.classList.add('valid');
                    else instructions.lower.classList.remove('valid');
                    // Uppercase
                    if (/[A-Z]/.test(value)) instructions.upper.classList.add('valid');
                    else instructions.upper.classList.remove('valid');
                    // Number
                    if (/\d/.test(value)) instructions.number.classList.add('valid');
                    else instructions.number.classList.remove('valid');
                    // Special
                    if (/[^a-zA-Z0-9]/.test(value)) instructions.special.classList.add('valid');
                    else instructions.special.classList.remove('valid');
                };
                signupPassword.addEventListener('input', validate);
            }
            // --- END NEW ---

            // --- NEW: Map Preview Logic ---
            const addMapPreview = (btnId, containerId, locationInputId) => {
                const btn = document.getElementById(btnId);
                const container = document.getElementById(containerId);
                const locationInput = document.getElementById(locationInputId);

                if (btn && container && locationInput) {
                    btn.addEventListener('click', () => {
                        const location = locationInput.value.trim();
                        if (location === "") {
                            // --- NEW: Use custom alert ---
                            showAlert('Error', 'Please enter a base location first to preview the map.', 'error');
                            return;
                        }
                        // Use Google Maps embed
                        const iframeSrc = `https://maps.google.com/maps?q=${encodeURIComponent(location)}&t=&z=13&ie=UTF8&iwloc=&output=embed`;
                        container.innerHTML = `<iframe src="${iframeSrc}" frameborder="0" scrolling="no" marginheight="0" marginwidth="0"></iframe>`;
                        container.style.display = 'block';
                    });
                }
            };

            addMapPreview('previewDriverMapBtn', 'driver-map-container', 'baseLocation'); // <-- FIX: Changed 'driverDestination' to 'baseLocation'
            addMapPreview('previewEmergencyMapBtn', 'emergency-map-container', 'baseLocation'); // <-- FIX: Changed 'emergencyDestination' to 'baseLocation'
            // --- END NEW ---

            // --- NEW: Circular Photo Uploader Logic ---
            const setupPhotoUploader = (portId, hiddenInputId, previewId, iconId, fileVarName) => {
                const port = document.getElementById(portId);
                const input = document.getElementById(hiddenInputId);
                const preview = document.getElementById(previewId);
                const icon = document.getElementById(iconId);

                if (!port || !input || !preview || !icon) return;

                // Click on port triggers hidden input
                port.addEventListener('click', () => {
                    input.click();
                });

                // When file is selected
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // Check file type
                        if (!file.type.startsWith('image/')) {
                            // --- NEW: Use custom alert ---
                            showAlert('Error', 'Invalid file type. Please select an image.', 'error');
                            return;
                        }
                        // Check file size (e.g., 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            // --- NEW: Use custom alert ---
                            showAlert('Error', 'File is too large. Please select an image under 5MB.', 'error');
                            return;
                        }

                        // Store the file in the global scope (using window[fileVarName])
                        window[fileVarName] = file;

                        // Show preview
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            preview.src = event.target.result;
                            preview.classList.add('active');
                            icon.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                });
            };

            setupPhotoUploader('driver-photo-uploader-port', 'driver-photo-input-hidden', 'driver-photo-preview', 'driver-photo-icon', 'driverPhotoFile');
            setupPhotoUploader('traveler-photo-uploader-port', 'traveler-photo-input-hidden', 'traveler-photo-preview', 'traveler-photo-icon', 'travelerPhotoFile');
            setupPhotoUploader('emergency-photo-uploader-port', 'emergency-photo-input-hidden', 'emergency-photo-preview', 'emergency-photo-icon', 'emergencyPhotoFile');
            // --- END NEW ---

            // --- NEW: Mobile Menu Toggle Logic ---
            const menuToggleBtn = document.getElementById('mobile-menu-toggle');
            const menuContainer = document.getElementById('nav-menu-container');
            const navLinks = document.querySelectorAll('#nav-menu-container .nav-links a');
            const dropdownLinks = document.querySelectorAll('#nav-menu-container .nav-links li.dropdown > a');

            if (menuToggleBtn && menuContainer) {
                menuToggleBtn.addEventListener('click', () => {
                    const isActive = menuContainer.classList.toggle('active');
                    menuToggleBtn.setAttribute('aria-expanded', isActive);
                    if (isActive) {
                        menuToggleBtn.innerHTML = '<i class="fas fa-times"></i>'; // Change to 'X'
                    } else {
                        menuToggleBtn.innerHTML = '<i class="fas fa-bars"></i>'; // Change back to 'bars'
                    }
                });
            }

            // Close menu when a non-dropdown link is clicked
            navLinks.forEach(link => {
                if (!link.parentElement.classList.contains('dropdown')) {
                    link.addEventListener('click', () => {
                        if (menuContainer.classList.contains('active')) {
                            menuContainer.classList.remove('active');
                            menuToggleBtn.setAttribute('aria-expanded', 'false');
                            menuToggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
                        }
                    });
                }
            });

            // Handle mobile dropdown toggling
            dropdownLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    // Only apply this logic if the mobile menu is active
                    if (window.innerWidth <= 992 && menuContainer.classList.contains('active')) {
                        e.preventDefault(); // Stop link from navigating
                        const parentLi = link.parentElement;
                        parentLi.classList.toggle('active'); // Toggle .active on the LI
                    }
                });
            });
            // --- END NEW Mobile Menu Logic ---

            // --- NEW: Desktop Dropdown Toggle Logic ---
            const desktopDropdownTriggers = document.querySelectorAll('.nav-links li.dropdown > a:not(#nav-user-info a)'); // All dropdowns except profile
            const profileDropdownTrigger = document.getElementById('nav-user-info'); // Profile
            const allDropdownLis = document.querySelectorAll('.nav-links li.dropdown');
            const profileDropdownMenu = document.getElementById('profile-dropdown-menu');

            const closeAllDropdowns = () => {
                allDropdownLis.forEach(li => li.classList.remove('active'));
                if (profileDropdownMenu) profileDropdownMenu.classList.remove('active'); // Explicitly close profile
            };

            // Handle standard dropdowns
            desktopDropdownTriggers.forEach(trigger => {
                trigger.addEventListener('click', (e) => {
                    // On mobile, this is handled by the mobile logic
                    if (window.innerWidth <= 992) return;

                    e.preventDefault(); // Stop navigation
                    const parentLi = trigger.parentElement;
                    const wasActive = parentLi.classList.contains('active');
                    closeAllDropdowns(); // Close all first
                    if (!wasActive) {
                        parentLi.classList.add('active'); // Open this one
                    }
                });
            });

            // Handle profile dropdown
            if (profileDropdownTrigger && profileDropdownMenu) {
                profileDropdownTrigger.addEventListener('click', (e) => {
                    e.preventDefault();
                    // On mobile, this is handled by the mobile logic
                    if (window.innerWidth <= 992) {
                        profileDropdownTrigger.parentElement.classList.toggle('active');
                        return;
                    }

                    const wasActive = profileDropdownMenu.classList.contains('active');
                    closeAllDropdowns(); // Close all first
                    if (!wasActive) {
                        profileDropdownMenu.classList.add('active'); // Open this one
                        profileDropdownTrigger.parentElement.classList.add('active'); // Keep parent active
                    }
                });
            }

            // Close all dropdowns if clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.nav-links')) {
                    closeAllDropdowns();
                }
            });
            // --- END NEW Desktop Dropdown Logic ---

            // --- NEW: Profile Modal Logic ---
            const allProfileModals = document.querySelectorAll('.profile-modal-overlay');

            // Function to close all modals
            const closeAllProfileModals = () => {
                allProfileModals.forEach(modal => {
                    modal.classList.remove('active');
                });
                // Also close the reg modal
                document.getElementById('reg-modal')?.classList.remove('active');
            };

            // Find all links that open a modal
            const modalTriggers = document.querySelectorAll('[data-modal-target]');
            modalTriggers.forEach(trigger => {
                trigger.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = trigger.dataset.modalTarget;
                    const targetModal = document.getElementById(targetId);
                    if (targetModal) {
                        closeAllProfileModals(); // Close all others first
                        targetModal.classList.add('active');
                    }
                    closeAllDropdowns(); // Close nav dropdowns
                });
            });

            // Add close logic to all modal close buttons
            allProfileModals.forEach(modal => {
                const closeBtn = modal.querySelector('.profile-modal-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        modal.classList.remove('active');
                    });
                }
                // Close on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            // --- END NEW Profile Modal Logic ---

            // --- NEW: Star Rating Logic ---
            const ratingContainer = document.querySelector('.star-rating-container');
            const stars = document.querySelectorAll('.star-rating-container .star');
            const submitReviewBtn = document.getElementById('submit-review-btn');

            if (ratingContainer && stars.length > 0) {
                let currentRating = 0;

                const setRating = (rating) => {
                    currentRating = rating;
                    ratingContainer.dataset.rating = rating;
                    stars.forEach(star => {
                        if (parseInt(star.dataset.value) <= rating) {
                            star.classList.add('selected');
                        } else {
                            star.classList.remove('selected');
                        }
                    });
                    if (submitReviewBtn) submitReviewBtn.disabled = false;
                };

                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        setRating(parseInt(star.dataset.value));
                    });

                    // Hover effects are handled by CSS, but we reset selection
                    star.addEventListener('mouseover', () => {
                        stars.forEach(s => s.classList.remove('selected'));
                    });
                });

                ratingContainer.addEventListener('mouseleave', () => {
                    // On mouse leave, restore the clicked rating
                    setRating(currentRating);
                });

                if (submitReviewBtn) {
                    submitReviewBtn.disabled = true; // Disable at first
                    submitReviewBtn.addEventListener('click', () => {
                        const reviewText = document.getElementById('review-comment').value;
                        console.log(`Rating: ${currentRating}, Review: ${reviewText}`);
                        // --- NEW: Use custom alert ---
                        // showAlert('Success', 'Your review has been submitted!', 'success');
                        
                        // Show success message inside modal
                        document.getElementById('rating-content').style.display = 'none';
                        document.getElementById('rating-success-message').style.display = 'block';

                        // Close modal after 2.5s
                        setTimeout(() => {
                            closeAllProfileModals();
                            // Reset modal for next time
                            document.getElementById('rating-content').style.display = 'block';
                            document.getElementById('rating-success-message').style.display = 'none';
                            document.getElementById('review-comment').value = '';
                            setRating(0);
                        }, 2500);
                    });
                }
            }
            // --- END NEW Star Rating Logic ---

            // --- NEW: FAQ Accordion Logic ---
            const faqItems = document.querySelectorAll('.faq-item');
            faqItems.forEach(item => {
                const title = item.querySelector('.faq-title');
                const details = item.querySelector('.faq-details');

                if (title && details) {
                    title.addEventListener('click', () => {
                        const isOpen = item.classList.toggle('active');
                        if (isOpen) {
                            details.classList.add('open');
                            details.style.maxHeight = details.scrollHeight + 'px';
                        } else {
                            details.classList.remove('open');
                            details.style.maxHeight = '0';
                        }
                    });
                }
            });
            // --- END NEW FAQ Logic ---

            // --- NEW: Wallet Modal Logic ---
            const addMoneyToggleBtn = document.getElementById('add-money-toggle-btn');
            const addMoneySection = document.getElementById('add-money-section');
            const addMoneyForm = document.getElementById('add-money-form');

            if (addMoneyToggleBtn && addMoneySection) {
                addMoneyToggleBtn.addEventListener('click', () => {
                    const isVisible = addMoneySection.style.display === 'block';
                    if (isVisible) {
                        addMoneySection.style.display = 'none';
                        addMoneyToggleBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Money';
                    } else {
                        addMoneySection.style.display = 'block';
                        addMoneyToggleBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
                    }
                });
            }

            if (addMoneyForm) {
                addMoneyForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const amount = document.getElementById('add-money-amount').value;
                    if (amount) {
                        // --- NEW: Use custom alert ---
                        showAlert('Payment Simulation', `You are about to add ₹${amount}. In a real app, this would open a payment gateway.`, 'info');
                        addMoneySection.style.display = 'none';
                        addMoneyToggleBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Money';
                        addMoneyForm.reset();
                        // In a real app, you'd update the balance after successful payment
                    }
                });
            }
            // --- END NEW Wallet Logic ---

            // --- NEW: Referral Code Copy Logic ---
            const copyBtn = document.getElementById('referral-copy-btn');
            const codeInput = document.getElementById('referral-code');

            if (copyBtn && codeInput) {
                copyBtn.addEventListener('click', () => {
                    // --- FIX: execCommand is more reliable in iframes ---
                    try {
                        codeInput.select();
                        document.execCommand('copy');
                        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy: ', err);
                        // --- NEW: Use custom alert ---
                        showAlert('Error', 'Failed to copy referral code.', 'error');
                    }
                });
            }
            // --- END NEW Referral Logic ---

            // --- NEW: Profile Photo Upload from Dropdown ---
            const galleryBtn = document.getElementById('photo-gallery-btn');
            const cameraBtn = document.getElementById('photo-camera-btn');
            const galleryInput = document.getElementById('photo-gallery-input');
            const cameraInput = document.getElementById('photo-camera-input');

            const handleProfilePhotoUpload = (file) => {
                if (!file) return;
                if (!window.currentUserId || !window.storage || !window.fs) {
                    showAlert('Error', 'You must be logged in to upload a photo.', 'error');
                    return;
                }

                // Show loading
                showAlert('Uploading', 'Your photo is being uploaded...', 'info');

                const photoRef = window.fs.storage_ref(window.storage, `artifacts/${window.appId}/user_photos/${window.currentUserId}/profile.jpg`);
                window.fs.uploadBytes(photoRef, file)
                    .then(snapshot => window.fs.getDownloadURL(snapshot.ref))
                    .then(async (photoUrl) => {
                        // Update Firestore
                        const userDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'users', window.currentUserId);
                        await window.fs.updateDoc(userDocRef, { photoUrl: photoUrl });

                        // Update local data
                        window.currentUserData.photoUrl = photoUrl;
                        document.getElementById('nav-user-photo').src = photoUrl;
                        
                        closeAlert(); // Close loading
                        showAlert('Success', 'Profile photo updated!', 'success');
                    })
                    .catch(error => {
                        console.error("Photo Upload Error:", error);
                        closeAlert(); // Close loading
                        showAlert('Error', `Photo upload failed: ${error.message}`, 'error');
                    });
            };

            if (galleryBtn && galleryInput) {
                galleryBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    galleryInput.click();
                    closeAllDropdowns();
                });
                galleryInput.addEventListener('change', () => {
                    handleProfilePhotoUpload(galleryInput.files[0]);
                });
            }
            if (cameraBtn && cameraInput) {
                cameraBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    cameraInput.click();
                    closeAllDropdowns();
                });
                cameraInput.addEventListener('change', () => {
                    handleProfilePhotoUpload(cameraInput.files[0]);
                });
            }
            // --- END NEW ---

            // --- NEW: Populate Modals from Firestore ---
            // These functions will be called by the auth listener
            
            // Populate Wallet
            window.populateWallet = () => {
                const balanceEl = document.getElementById('wallet-balance-amount');
                if (balanceEl && window.currentUserData && typeof window.currentUserData.walletBalance !== 'undefined') {
                    balanceEl.textContent = `₹${window.currentUserData.walletBalance.toFixed(2)}`;
                } else if (balanceEl) {
                    balanceEl.textContent = '₹0.00';
                }
            };
            
            // Populate Rides
            window.populateRides = async () => {
                const listEl = document.getElementById('ride-history-list-content');
                if (!listEl || !window.currentUserId || !window.db || !window.fs) {
                    if(listEl) listEl.innerHTML = '<li>Please log in to see your ride history.</li>';
                    return;
                }

                try {
                    const q = window.fs.query(window.fs.collection(window.db, 'artifacts', window.appId, 'users', window.currentUserId, 'rides'));
                    const querySnapshot = await window.fs.getDocs(q);
                    
                    if (querySnapshot.empty) {
                        listEl.innerHTML = '<li>You have no ride history.</li>';
                        return;
                    }

                    listEl.innerHTML = ''; // Clear loading
                    querySnapshot.forEach((doc) => {
                        const ride = doc.data();
                        const iconClass = ride.type === 'car' ? 'fa-car' : 'fa-motorcycle';
                        const date = new Date(ride.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                        listEl.innerHTML += `
                            <li class="ride-item">
                                <div class="icon"><i class="fas ${iconClass}"></i></div>
                                <div class="ride-details">
                                    <p>${ride.location}</p>
                                    <span>${date} - ${ride.driver}</span>
                                </div>
                                <div class="ride-price">₹${ride.price}</div>
                            </li>
                        `;
                    });
                } catch (error) {
                    console.error("Error fetching rides:", error);
                    listEl.innerHTML = '<li>Error loading ride history.</li>';
                }
            };
            
            // Populate Rewards
            window.populateRewards = async () => {
                const listEl = document.getElementById('rewards-list-content');
                if (!listEl || !window.currentUserId || !window.db || !window.fs) {
                    if (listEl) listEl.innerHTML = '<li>Please log in to see your rewards.</li>';
                    return;
                }

                try {
                    const q = window.fs.query(window.fs.collection(window.db, 'artifacts', window.appId, 'users', window.currentUserId, 'rewards'));
                    const querySnapshot = await window.fs.getDocs(q);
                    
                    if (querySnapshot.empty) {
                        listEl.innerHTML = '<li>You have no rewards available.</li>';
                        return;
                    }

                    listEl.innerHTML = ''; // Clear loading
                    querySnapshot.forEach((doc) => {
                        const reward = doc.data();
                        const claimed = reward.claimed;
                        listEl.innerHTML += `
                            <li class="reward-item" style="${claimed ? 'opacity: 0.6;' : ''}">
                                <div class="icon"><i class="fas ${reward.icon || 'fa-gift'}"></i></div>
                                <div class="details">
                                    <h4>${reward.title}</h4>
                                    <p>${reward.description}</p>
                                </div>
                                <button class="claim-btn" ${claimed ? 'disabled' : ''}>
                                    ${claimed ? 'Claimed' : 'Claim'}
                                </button>
                            </li>
                        `;
                    });
                } catch (error) {
                    console.error("Error fetching rewards:", error);
                    listEl.innerHTML = '<li>Error loading rewards.</li>';
                }
            };
            // --- END NEW ---

            // --- NEW: Role-Specific Action Button Listeners ---
            
            // --- TRAVELER ---
            const bookMyRideBtn = document.getElementById('book-my-ride-btn');
            const bookRideForm = document.getElementById('book-ride-form');
            const bookRideError = document.getElementById('book-ride-error');
            const bidsListContent = document.getElementById('bids-list-content');
            const cancelRideRequestBtn = document.getElementById('cancel-ride-request-btn');
            const trackingMap = document.getElementById('tracking-map');

            // 1. Click "Book My Ride" button
            if (bookMyRideBtn) {
                bookMyRideBtn.addEventListener('click', () => {
                    document.getElementById('book-ride-modal').classList.add('active');
                });
            }

            // 2. Submit "Book My Ride" form
            if (bookRideForm) {
                bookRideForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!window.currentUserId || !window.db || !window.fs) {
                        bookRideError.textContent = 'You must be logged in.';
                        bookRideError.style.display = 'block';
                        return;
                    }

                    const from = bookRideForm['ride-from'].value;
                    const to = bookRideForm['ride-to'].value;
                    const fare = bookRideForm['ride-fare'].value;

                    try {
                        // Create a new ride request in the public collection
                        const rideRequestRef = await window.fs.addDoc(
                            window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'ride-requests'),
                            {
                                travelerId: window.currentUserId,
                                travelerName: window.currentUserData.name || 'Anonymous',
                                from: from,
                                to: to,
                                offeredFare: fare ? parseFloat(fare) : null,
                                status: 'pending', // Status: pending, accepted, complete, cancelled
                                createdAt: new Date().toISOString()
                            }
                        );
                        
                        console.log("Ride request created:", rideRequestRef.id);
                        window.currentRideRequestId = rideRequestRef.id; // <-- Store this ID

                        // Close book modal, open bidding modal
                        document.getElementById('book-ride-modal').classList.remove('active');
                        document.getElementById('bidding-modal').classList.add('active');
                        
                        // Attach listener for bids on THIS ride request
                        attachRideBidsListener(rideRequestRef.id);
                        // Attach listener for THIS ride's status changing
                        attachTripStatusListener(rideRequestRef.id);

                    } catch (error) {
                        console.error("Error creating ride request:", error);
                        bookRideError.textContent = `Error: ${error.message}`;
                        bookRideError.style.display = 'block';
                    }
                });
            }

            // 3. Attach listener for bids (for traveler)
            const attachRideBidsListener = (rideId) => {
                if (window.rideBidsListener) window.rideBidsListener(); // Detach old
                if (!window.db || !window.fs) return;

                const q = window.fs.query(
                    window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'ride-requests', rideId, 'bids')
                );
                
                bidsListContent.innerHTML = ''; // Clear list

                window.rideBidsListener = window.fs.onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        bidsListContent.innerHTML = `<li style="text-align: center; color: #777; padding: 20px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 1.5em;"></i>
                            <p style="margin-top: 10px;">Listening for nearby drivers...</p>
                        </li>`;
                        return;
                    }
                    
                    bidsListContent.innerHTML = ''; // Clear list
                    snapshot.forEach(doc => {
                        const bid = doc.data();
                        bidsListContent.innerHTML += `
                            <li class="bid-item">
                                <div class="driver-info">
                                    <p>${bid.driverName}</p>
                                    <span>${bid.vehicleType} - ${bid.vehicleModel}</span>
                                </div>
                                <div class="bid-amount">₹${bid.bidAmount}</div>
                                <button class="accept-bid-btn" data-bid-id="${doc.id}" data-driver-id="${bid.driverId}">
                                    Accept
                                </button>
                            </li>
                        `;
                    });
                });
            };

            // 4. Attach listener for trip status (for traveler)
            const attachTripStatusListener = (rideId) => {
                if (window.tripStatusListener) window.tripStatusListener(); // Detach old
                if (!window.db || !window.fs) return;

                const rideDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'ride-requests', rideId);
                
                window.tripStatusListener = window.fs.onSnapshot(rideDocRef, (doc) => {
                    if (!doc.exists()) {
                        console.log("Ride request deleted or cancelled.");
                        closeAllProfileModals();
                        showAlert('Ride Cancelled', 'Your ride request was cancelled.', 'info');
                        window.currentRideRequestId = null;
                        if (window.rideBidsListener) window.rideBidsListener();
                        if (window.tripStatusListener) window.tripStatusListener();
                        return;
                    }

                    const ride = doc.data();
                    if (ride.status === 'accepted' && ride.driverId) {
                        // RIDE IS ACCEPTED!
                        console.log("Ride accepted by driver:", ride.driverId);

                        // Close bidding modal, open tracking modal
                        document.getElementById('bidding-modal').classList.remove('active');
                        document.getElementById('tracking-modal').classList.add('active');

                        // Populate tracking modal
                        document.getElementById('tracking-driver-name').textContent = ride.driverName || '...';
                        document.getElementById('tracking-driver-vehicle').textContent = `${ride.driverVehicleMake || ''} ${ride.driverVehicleModel || ''}`;
                        document.getElementById('tracking-driver-license').textContent = ride.driverLicensePlate || '...';
                        
                        // Start tracking driver's location
                        startTrackingDriverLocation(rideId, trackingMap);

                        // Detach the bids listener, we don't need it
                        if (window.rideBidsListener) window.rideBidsListener();
                        window.rideBidsListener = null;

                    } else if (ride.status === 'started') {
                        // RIDE HAS STARTED
                        document.getElementById('tracking-driver-status').textContent = 'Ride in progress...';

                    } else if (ride.status === 'complete') {
                        // RIDE IS COMPLETE
                        document.getElementById('final-fare-amount').textContent = `₹${ride.finalFare || ride.bidAmount || '0.00'}`;
                        document.getElementById('tracking-modal').classList.remove('active');
                        document.getElementById('ride-complete-modal').classList.add('active');
                        
                        // Stop all listeners
                        if (window.tripStatusListener) window.tripStatusListener();
                        window.tripStatusListener = null;
                        window.currentRideRequestId = null;
                    }
                });
            };

            // 5. Click "Accept" on a bid
            bidsListContent.addEventListener('click', async (e) => {
                if (e.target.classList.contains('accept-bid-btn')) {
                    if (!window.currentRideRequestId) return;
                    
                    const bidId = e.target.dataset.bidId;
                    const driverId = e.target.dataset.driverId;
                    const bidAmount = e.target.parentElement.querySelector('.bid-amount').textContent.replace('₹', '');
                    const driverName = e.target.parentElement.querySelector('.driver-info p').textContent;

                    // Disable all accept buttons
                    bidsListContent.querySelectorAll('.accept-bid-btn').forEach(btn => btn.disabled = true);
                    e.target.textContent = 'Accepting...';
                    
                    try {
                        // Get driver details
                        const driverDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'users', driverId);
                        const driverDoc = await window.fs.getDoc(driverDocRef);
                        const driverData = driverDoc.exists() ? driverDoc.data() : {};

                        // Update the main ride request document
                        const rideDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'ride-requests', window.currentRideRequestId);
                        await window.fs.updateDoc(rideDocRef, {
                            status: 'accepted',
                            driverId: driverId,
                            driverName: driverName,
                            bidAmount: parseFloat(bidAmount),
                            acceptedBidId: bidId,
                            driverVehicleMake: driverData.vehicleMake || '',
                            driverVehicleModel: driverData.vehicleModel || '',
                            driverLicensePlate: driverData.licensePlate || ''
                        });

                        // The tripStatusListener will handle the UI change
                        console.log("Accepted bid!");

                    } catch (error) {
                        console.error("Error accepting bid:", error);
                        showAlert('Error', `Failed to accept bid: ${error.message}`, 'error');
                        // Re-enable buttons
                        bidsListContent.querySelectorAll('.accept-bid-btn').forEach(btn => btn.disabled = false);
                        e.target.textContent = 'Accept';
                    }
                }
            });

            // 6. Click "Cancel Ride Request"
            if (cancelRideRequestBtn) {
                cancelRideRequestBtn.addEventListener('click', async () => {
                    if (!window.currentRideRequestId) return;

                    try {
                        const rideDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'ride-requests', window.currentRideRequestId);
                        await window.fs.updateDoc(rideDocRef, { status: 'cancelled' });
                        // In a real app, you might delete it
                        // await window.fs.deleteDoc(rideDocRef);

                        // Close modal and listeners
                        closeAllProfileModals();
                        if (window.rideBidsListener) window.rideBidsListener();
                        if (window.tripStatusListener) window.tripStatusListener();
                        window.rideBidsListener = null;
                        window.tripStatusListener = null;
                        window.currentRideRequestId = null;
                        showAlert('Cancelled', 'Your ride request has been cancelled.', 'info');

                    } catch (error) {
                        console.error("Error cancelling ride:", error);
                        showAlert('Error', `Could not cancel ride: ${error.message}`, 'error');
                    }
                });
            }

            // 7. Click "Rate Your Driver"
            const rateDriverBtn = document.getElementById('rate-driver-btn');
            if (rateDriverBtn) {
                rateDriverBtn.addEventListener('click', () => {
                    document.getElementById('ride-complete-modal').classList.remove('active');
                    document.getElementById('rating-modal').classList.add('active');
                });
            }

            // 8. Location Tracking (Traveler)
            const startTrackingDriverLocation = (rideId, mapElement) => {
                const locationDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'driver-locations', rideId);
                
                // Use a simple map embed for demo
                mapElement.innerHTML = `<iframe src="https://maps.google.com/maps?q=Gurugram&t=&z=13&ie=UTF8&iwloc=&output=embed" frameborder="0" scrolling="no" marginheight="0" marginwidth="0"></iframe>`;
                
                // In a real app, you'd listen to locationDocRef with onSnapshot
                // and update a marker on a Google Maps JS API instance.
                // For this demo, we just show a static map.
                
                // Example of listener (but we don't have a map to update):
                /*
                window.fs.onSnapshot(locationDocRef, (doc) => {
                    if (doc.exists()) {
                        const { lat, lng } = doc.data();
                        console.log("Driver at:", lat, lng);
                        // Update map marker position...
                    }
                });
                */
            };
            

            // --- DRIVER ---
            const viewRideRequestsBtn = document.getElementById('view-ride-requests-btn');
            const rideRequestsListContent = document.getElementById('ride-requests-list-content');
            const makeOfferForm = document.getElementById('make-offer-form');
            const makeOfferError = document.getElementById('make-offer-error');

            // 1. Click "View Ride Requests"
            if (viewRideRequestsBtn) {
                viewRideRequestsBtn.addEventListener('click', () => {
                    document.getElementById('ride-requests-modal').classList.add('active');
                    // Attach listener for new ride requests
                    attachRideRequestsListener();
                });
            }

            // 2. Attach listener for ride requests (for driver)
            const attachRideRequestsListener = () => {
                if (window.rideRequestsListener) return; // Already attached
                if (!window.db || !window.fs) return;

                const q = window.fs.query(
                    window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'ride-requests'),
                    window.fs.where('status', '==', 'pending')
                );

                rideRequestsListContent.innerHTML = ''; // Clear

                window.rideRequestsListener = window.fs.onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        rideRequestsListContent.innerHTML = '<li>No active ride requests right now.</li>';
                        return;
                    }
                    
                    rideRequestsListContent.innerHTML = ''; // Clear
                    snapshot.forEach(doc => {
                        const req = doc.data();
                        rideRequestsListContent.innerHTML += `
                            <li class="modal-list-item ride-request-item">
                                <div class="icon"><i class="fas fa-user"></i></div>
                                <div class="details">
                                    <p>${req.travelerName}</p>
                                    <span><strong>From:</strong> ${req.from}</span>
                                    <span><strong>To:</strong> ${req.to}</span>
                                    ${req.offeredFare ? `<span><strong>Offer:</strong> ₹${req.offeredFare}</span>` : ''}
                                </div>
                                <button class="make-offer-btn"
                                    data-ride-id="${doc.id}"
                                    data-from="${req.from}"
                                    data-to="${req.to}"
                                    data-fare="${req.offeredFare || ''}">
                                    Make Offer
                                </button>
                            </li>
                        `;
                    });
                });
            };

            // 3. Click "Make Offer"
            rideRequestsListContent.addEventListener('click', (e) => {
                if (e.target.classList.contains('make-offer-btn')) {
                    const rideId = e.target.dataset.rideId;
                    const from = e.target.dataset.from;
                    const to = e.target.dataset.to;
                    const fare = e.target.dataset.fare;
                    
                    // Populate and open "Make Offer" modal
                    document.getElementById('offer-ride-from').textContent = from;
                    document.getElementById('offer-ride-to').textContent = to;
                    document.getElementById('offer-ride-fare').textContent = fare ? `₹${fare}` : 'N/A';
                    document.getElementById('driver-bid-amount').value = fare || '';
                    document.getElementById('offer-ride-request-id').value = rideId;
                    
                    document.getElementById('make-offer-modal').classList.add('active');
                }
            });

            // 4. Submit "Make Offer" form
            if (makeOfferForm) {
                makeOfferForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!window.currentUserId || !window.db || !window.fs) {
                        makeOfferError.textContent = 'You must be logged in.';
                        makeOfferError.style.display = 'block';
                        return;
                    }

                    const rideId = document.getElementById('offer-ride-request-id').value;
                    const bidAmount = makeOfferForm['driver-bid-amount'].value;

                    if (!rideId || !bidAmount) {
                        makeOfferError.textContent = 'Missing bid details.';
                        makeOfferError.style.display = 'block';
                        return;
                    }
                    
                    try {
                        // Add bid to the subcollection
                        const bidsColRef = window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'ride-requests', rideId, 'bids');
                        await window.fs.addDoc(bidsColRef, {
                            driverId: window.currentUserId,
                            driverName: window.currentUserData.name || 'Driver',
                            vehicleType: window.currentUserData.vehicleType || 'Car',
                            vehicleModel: window.currentUserData.vehicleModel || '',
                            bidAmount: parseFloat(bidAmount),
                            createdAt: new Date().toISOString()
                        });

                        // Close modal
                        document.getElementById('make-offer-modal').classList.remove('active');
                        showAlert('Success', 'Your offer has been submitted to the traveler.', 'success');

                    } catch (error) {
                        console.error("Error making offer:", error);
                        makeOfferError.textContent = `Error: ${error.message}`;
                        makeOfferError.style.display = 'block';
                    }
                });
            }
            
            // 5. Driver location sending
            window.startSendingDriverLocation = (rideId) => {
                if (window.driverLocationInterval) clearInterval(window.driverLocationInterval);
                
                // Simulate location updates
                window.driverLocationInterval = setInterval(async () => {
                    if (!rideId || !window.db || !window.fs) return;
                    
                    // Simulate a new location (e.g., random coords near Gurugram 28.4595, 77.0266)
                    const lat = 28.4595 + (Math.random() - 0.5) * 0.01;
                    const lng = 77.0266 + (Math.random() - 0.5) * 0.01;
                    
                    try {
                        const locationDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'driver-locations', rideId);
                        await window.fs.setDoc(locationDocRef, {
                            lat: lat,
                            lng: lng,
                            updatedAt: new Date().toISOString()
                        });
                        console.log("Sent driver location:", lat, lng);
                    } catch (error) {
                        console.error("Error sending location:", error);
                    }
                }, 10000); // Send location every 10 seconds
            };

            window.stopSendingDriverLocation = () => {
                if (window.driverLocationInterval) {
                    clearInterval(window.driverLocationInterval);
                    window.driverLocationInterval = null;
                    console.log("Stopped sending driver location.");
                }
            };
            
            // 6. Driver ride controls (Start/End/Cancel)
            const startRideBtn = document.getElementById('start-ride-btn');
            const endRideBtn = document.getElementById('end-ride-btn');
            const cancelRideBtn = document.getElementById('cancel-ride-btn');

            if (startRideBtn) {
                startRideBtn.addEventListener('click', async () => {
                    if (!window.currentRideRequestId) return;
                    try {
                        const rideDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'ride-requests', window.currentRideRequestId);
                        await window.fs.updateDoc(rideDocRef, { status: 'started' });
                        startRideBtn.style.display = 'none';
                        endRideBtn.style.display = 'block';
                    } catch (e) { showAlert('Error', 'Could not start ride', 'error'); }
                });
            }
            
            if (endRideBtn) {
                endRideBtn.addEventListener('click', async () => {
                    if (!window.currentRideRequestId) return;
                    try {
                        const rideDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'ride-requests', window.currentRideRequestId);
                        // Get final fare from bid
                        const rideDoc = await window.fs.getDoc(rideDocRef);
                        const finalFare = rideDoc.data().bidAmount || 100; // Fallback
                        
                        await window.fs.updateDoc(rideDocRef, { 
                            status: 'complete',
                            finalFare: finalFare
                        });
                        
                        // Close modal, stop sending location
                        document.getElementById('new-pickup-modal').classList.remove('active');
                        stopSendingDriverLocation();
                        window.currentRideRequestId = null;
                        startRideBtn.style.display = 'block'; // Reset buttons
                        endRideBtn.style.display = 'none';
                        
                    } catch (e) { showAlert('Error', 'Could not end ride', 'error'); }
                });
            }
            
            if (cancelRideBtn) {
                cancelRideBtn.addEventListener('click', async () => {
                     if (!window.currentRideRequestId) return;
                    try {
                        const rideDocRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'ride-requests', window.currentRideRequestId);
                        await window.fs.updateDoc(rideDocRef, { status: 'cancelled' });
                        
                        // Close modal, stop sending location
                        document.getElementById('new-pickup-modal').classList.remove('active');
                        stopSendingDriverLocation();
                        window.currentRideRequestId = null;
                        startRideBtn.style.display = 'block'; // Reset buttons
                        endRideBtn.style.display = 'none';
                        
                    } catch (e) { showAlert('Error', 'Could not cancel ride', 'error'); }
                });
            }


            // --- EMERGENCY ---
            const viewActiveAlertsBtn = document.getElementById('view-active-alerts-btn');
            const getPriorityRouteBtn = document.getElementById('get-priority-route-btn');
            const priorityRouteForm = document.getElementById('priority-route-form');

            if (viewActiveAlertsBtn) {
                viewActiveAlertsBtn.addEventListener('click', () => {
                    document.getElementById('active-alerts-modal').classList.add('active');
                    // In a real app, you'd attach a listener for alerts here
                });
            }
            
            if (getPriorityRouteBtn) {
                getPriorityRouteBtn.addEventListener('click', () => {
                    document.getElementById('priority-route-modal').classList.add('active');
                });
            }

            if (priorityRouteForm) {
                priorityRouteForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const destination = priorityRouteForm['route-destination'].value;
                    showAlert('Feature Demo', `Generating priority route to ${destination}. In a real app, this would optimize AI traffic lights.`, 'info');
                    closeAllProfileModals();
                });
            }
            
            // --- SOS/Share Buttons ---
            document.getElementById('share-ride-btn')?.addEventListener('click', () => {
                showAlert('Feature Demo', 'This would share your live location with trusted contacts.', 'info');
            });
            document.getElementById('sos-btn')?.addEventListener('click', () => {
                showAlert('SOS Activated!', 'Your location and details are being sent to emergency services and trusted contacts.', 'error');
            });


        }); // End DOMContentLoaded
    </script>
</body>

</html>